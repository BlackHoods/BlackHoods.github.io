<!DOCTYPE html>
<html>
<head>
    <meta name="generator" content="Hugo 0.31.1" />

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Blog about - {CTFs | Pwning | Reversing}">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <link rel="icon" type="image/png" href="/images/favicon.ico">

    
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" sizes="192x192" href="/images/touch/chrome-touch-icon-192x192.png">

    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Material Design Lite">
    <link rel="apple-touch-icon-precomposed" href="apple-touch-icon-precomposed.png">

    
    <meta name="msapplication-TileImage" content="images/touch/ms-touch-icon-144x144-precomposed.png">
    <meta name="msapplication-TileColor" content="#3372DF">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en"/>
    <link rel="stylesheet" href="/css/ionicons.min.css"/>
    <link rel="stylesheet" href="https://storage.googleapis.com/code.getmdl.io/1.1.3/material.grey-orange.min.css"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="/css/hmdl-style.css"/>
	<link rel="stylesheet" href="/css/pygment.css">


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-103806632-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>


    <title>NgrBot - Malware capabilities analysis (Part 3)</title>
</head>

<body style="background-image: url('/images/background.jpg');">
    <div id="MainCnt" class="hmdl-body mdl-layout mdl-js-layout has-drawer is-upgraded">        
        <header class="mdl-layout__header mdl-layout__header--transparent mdl-layout__header--scroll">
            <div class="mdl-layout__header-row">
                <div class="mdl-layout-spacer"></div>
                <nav class="mdl-navigation">
                <a class="mdl-navigation__link" href="/">Home</a>
                <a class="mdl-navigation__link" href="/post/">Articles</a>
                <a class="mdl-navigation__link" href="/project/">Projects</a>
                <a class="mdl-navigation__link" href="/about/">About</a>
                </nav>
            </div>
        </header>
        <div class="mdl-layout__drawer">
            <nav class="mdl-navigation">
            <a class="mdl-navigation__link" href="/">Home</a>
            <a class="mdl-navigation__link" href="/post/">Articles</a>
            <a class="mdl-navigation__link" href="/project/">Projects</a>
            <a class="mdl-navigation__link" href="/about/">About</a>
            </nav>
        </div>

        <main class="mdl-layout__content">

		

            <div class="hmdl-page mdl-grid">
                <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">
                    <div class="mdl-card__media mdl-color-text--grey-50" style=" background-color:orange;">
                        <h3 style="color:white;">NgrBot - Malware Capabilities Analysis (Part 3)</h3>
                    </div>
                    <div class="hmdl-page-meta mdl-color-text--grey-700 mdl-card__supporting-text">
                        <div class="minilogo" style="background-image: url('/images/Doopel_Profile/dopelrIcon.png');"></div>

                        <div>
							<strong>
                            		<strong>Doopel</strong>
							</strong>
                            <span>Feb 4, 2018</span>
                        </div>
                        <div class="section-spacer"></div>
                    </div>
                    <div class="hmdl-page-content mdl-color-text--grey-700 mdl-card__supporting-text">
                        

<h2 id="resume">Resume</h2>

<p>At this point we found or self in the last state of our analysis where we are going to understand what does the Malware once it is injected and it starts to do the real Malware actions to the victim machine.</p>

<p>We have seen before that in section .data that provides as some idea of what kind of actions it can takes:</p>

<ul>
<li><strong>Anti-virus detection</strong></li>
<li><strong>IRC commands:</strong> USER, NICK, JOIN, PART, PRIVMSG, QUIT, PONG, PING, PRIVMSG</li>
<li><strong>Browsers injection:</strong>  i e x p l o r e . e x e     f i r e f o x . e x e</li>

<li><p><strong>Registers (persistent):</strong></p>

<ul>
<li>S o f t w a r e \ M i c r o s o f t \ W i n d o w s \ C u r r e n t V e r s i o n \ R u n<br /></li>
<li>S o f t w a r e \ M i c r o s o f t \ W i n d o w s \ C u r r e n t V e r s i o n \ P o l i c i e s \ S y s t e m</li>
</ul></li>

<li><p><strong>Auto Update</strong></p></li>

<li><p><strong>Hijacking</strong></p></li>

<li><p><strong>DDOS:</strong> SYN flood, UDP flood.</p></li>

<li><p><strong>Propagation:</strong></p>

<ul>
<li>USB</li>
<li>Mail</li>
<li>Malicious HTML injection</li>
<li>FTP brute force</li>
<li>DNS poisoning</li>
<li>Network Shared folder</li>
</ul></li>

<li><p><strong>Credential stealing</strong></p></li>
</ul>

<h2 id="attach-to-iexplorer">Attach to iExplorer</h2>

<p>To be able to keep debugging the new injected code. As we saw before it receives input parameters that we will not be capable of provided if we just execute the dump executable. So to stop just in the malicious startAddress what I did was:</p>

<ul>
<li>Stop just before “CreateRemoteThread” execution</li>
</ul>

<p><img src="/assets/NgrBot/iexplorer_attach/stop_before.png" alt="stop_before" /></p>

<ul>
<li>Attach to iExlorer and set a breakpoint in the malicious start address:</li>
</ul>

<p><img src="/assets/NgrBot/iexplorer_attach/IE_bp.png" alt="IE_bp" /></p>

<ul>
<li>Execute call “CreateRemoteThread” and switch to iExplorer debugger to keep debugging.</li>
</ul>

<p><strong>Note:</strong> we know the start address (startAddress != entry-point) because it was passed as argument to “CreateRemoteThread” <strong>10BC374</strong></p>

<ul>
<li>In iExplorer debug process to be able to debug just the malicious code in a comfortable way, I suggest to identify and suspend iExplore’s thread who is in charge of the thread management (it will the only which is active).</li>
</ul>

<p><img src="/assets/NgrBot/iexplorer_attach/IE_thread.png" alt="IE_thread" /></p>

<h2 id="iexplorer-injected-code-analysis">IExplorer Injected code analysis</h2>

<p>An interesting thing that we can see is that the execution is not going to start from the PE Entry-point (<strong>0040B090</strong>) otherwise it will start from the address (<strong>0040C374</strong>) as we identified when the RemoteThread was launch. That indicates that it will inject piece of code depending of what actions it pretends to do in an irregular flow.</p>

<h4 id="scenario-set-up">Scenario set up</h4>

<p>The first actions it does once it is injected are the followed:</p>

<ul>
<li>Loads all the DLL’s function that it will need.</li>
<li>Privilege escalation:

<ul>
<li>In order to provide itself “SeDebugPrivilege” it does as follow:
<img src="/assets/NgrBot/iexplorer_attach/set-up/Debug_privilege.png" alt="Debug_privilege" /></li>
<li>First of all it opens a process token which will be its own token because OpenProcessToken receive as handler parameter “FFFFFFFF” which is a <strong>Pseudo handler of “GetCurrentProcess”.</strong></li>
<li>It checks if it has been injected in a process with “SeDebugPrivilege”.</li>
<li>If not it will modify the privileges.
<img src="/assets/NgrBot/iexplorer_attach/set-up/mod_debug_privilege.png" alt="mod_debug_privilege" /></li>
<li>Hooking Ntdll API
<strong>Note:</strong> it will not affect the other processes but as it tries to inject everywhere &hellip;

<ul>
<li>ZwResumeThread
<img src="/assets/NgrBot/iexplorer_attach/set-up/resume_thread.png" alt="resume_thread" /></li>
<li>LdrLoadDll
<img src="/assets/NgrBot/iexplorer_attach/set-up/LdrLoadDll.png" alt="LdrLoadDll" /></li>
</ul></li>
</ul></li>
</ul>

<h4 id="threads-nightmare">Threads nightmare</h4>

<p>At this point the code will be executed by pieces creating different threads to do specific tasks. At the beginning it will create two new threads which will point different code blocks that at the same time they will create more threads :S. Coming up next it will be schematized the different threads that I was able to identified and what functionalities are assigned to each one.</p>

<ol>
<li><strong>Get system information, address:</strong> 010BB2F0 (0040B2F0)

<ol>
<li><strong>Inject itself in other process, address:</strong> 010BCE58 (0040CE58)</li>
</ol></li>
<li><strong>Thread launcher, address:</strong> 010B8B20 (00408B20)

<ol>
<li><strong>Botnet communication, address:</strong> 010B91E0 (004091E0)
<img src="/assets/NgrBot/iexplorer_attach/thread_nightmare/botnet_comm.png" alt="botnet_comm" />
<img src="/assets/NgrBot/iexplorer_attach/thread_nightmare/botnet_traffic.png" alt="botnet_traffic" />
<img src="/assets/NgrBot/iexplorer_attach/thread_nightmare/botnet_traffic_2.png" alt="botnet_traffic_2" />
<img src="/assets/NgrBot/iexplorer_attach/thread_nightmare/botnet_traffic_3.png" alt="botnet_traffic_3" />
<img src="/assets/NgrBot/iexplorer_attach/thread_nightmare/botnet_traffic_4.png" alt="botnet_traffic_4" /></li>
<li><strong>Create Windows</strong> address: 010BAB60 (0040AB60)
<img src="/assets/NgrBot/iexplorer_attach/thread_nightmare/create_window.png" alt="create_window" /></li>
<li><strong>Orders deliverer:</strong> Creates Pipe and launch the orders switch thread. Address 010B8D00 (00408D00)
<img src="/assets/NgrBot/iexplorer_attach/thread_nightmare/pipe.png" alt="pipe" />

<ol>
<li><strong>Orders switch</strong>, address: 010B8DD0 (00408DD0)</li>
</ol></li>
</ol></li>
</ol>

<h4 id="modules-and-features">Modules and Features</h4>

<p>Now it is going to wait for orders from the bot master. As we have seen all the IRCs servers are down so we only can analyse the static code of each important functionality that we have mentioned before.</p>

<p><strong>Note:</strong> As the code is fragmented and it is quite long the fastest way to find interesting function is to check the String and find where they are in used.</p>

<ol>
<li><p><strong>Rootkit</strong></p>

<p>The Malware comes with rootkit component to hide its presence in the infected machine. The Malware injects code into all running processes in the machine and hooks different APIs such as:</p>

<ul>
<li>wininet.dll.InternetWriteFile</li>
<li>wininet.dll.HttpSendRequestW</li>
<li>wininet.dll.HttpSendRequestA</li>
<li>ws2_32.dll.getaddrinfo</li>
<li>ws2_32.dll.send</li>
<li>nspr4.dll.PR_Write</li>
<li>kernel32.dll.CopyFileW</li>
<li>kernel32.dll.CopyFileA</li>
<li>kernel32.dll.CreateFileW</li>
<li>kernel32.dll.CreateFileA</li>
<li>kernel32.dll.MoveFileW</li>
<li>kernel32.dll.MoveFileA
<br /></li>
</ul>

<p>With the hooks, the Malware has the power to intercept the browser activities of the victim, steal credentials, instruct the bot for further download of Malware by the remote attacker etc.</p></li>

<li><p><strong>Ruskill</strong></p>

<p>The Ruskill module will, if enabled for a download command, monitor the downloaded files as it executes. Ruskill will flag any files that it copies itself or creates to be deleted at the next system reboot by the module <strong>pdef</strong> and it will notify his master of each detection (file, DNS or registry modification).</p></li>
</ol>

<p><img src="/assets/NgrBot/iexplorer_attach/modules/ruskill.png" alt="ruskill" />
<img src="/assets/NgrBot/iexplorer_attach/modules/ruskill2.png" alt="ruskill2" /></p>

<ol>
<li><p><strong>Proactive defence</strong></p>

<p>The PDef module is an advanced threat detection and removal system. It monitors a range of file and networking API’s to detect and neutralize other threats that are running on the system. Currently this module can detect, block and remove Malware that spreads via USB drives, browser exploit packs, and bots that use IRC to communicate.</p></li>
</ol>

<p><img src="/assets/NgrBot/iexplorer_attach/modules/pdef.png" alt="pdef" />
<img src="/assets/NgrBot/iexplorer_attach/modules/pdef2.png" alt="pdef2" /></p>

<ol>
<li><p><strong>DNS Modifier</strong></p>

<p>This module can block domains from being accessed and redirect domains/IP addresses to others.</p></li>
</ol>

<p><img src="/assets/NgrBot/iexplorer_attach/modules/dns.png" alt="dns" /></p>

<ol>
<li><p><strong>Slowloris</strong></p>

<p>This module is for web servers running Apache HTTPd. It’s designed to use low bandwidth and to maintain connections as long as possible, thus consuming all available resources.</p></li>
</ol>

<p><img src="/assets/NgrBot/iexplorer_attach/modules/slowloris.png" alt="slowloris" /></p>

<ol>
<li><p><strong>SYN Flood</strong></p>

<p>This module is also design to target web servers running Apache HTTPd. It is a form of DDOS in which an attacker sends a succession of SYN requests to a target&rsquo;s system in an attempt to consume enough server resources to make the system unresponsive to legitimate traffic.</p>

<p>The SYN flood module is good alternative for web servers that Slowloris fails to take down.</p></li>
</ol>

<p><img src="/assets/NgrBot/iexplorer_attach/modules/syn.png" alt="syn" /></p>

<ol>
<li><p><strong>UDP Flood</strong></p>

<p>The main intention of a UDP flood is to saturate the Internet pipe. Another impact of this attack is on the network and security elements on the way to the target server, and most typically the firewalls. Firewalls open a state for each UDP packet and will be overwhelmed by the flood connections very fast.</p></li>
</ol>

<p><img src="/assets/NgrBot/iexplorer_attach/modules/udp.png" alt="udp" /></p>

<ol>
<li><p><strong>Browser Login Grabber</strong></p>

<p>This module hooks <strong>nspr4.dll</strong> and analyses POST requests made by web browser to capture usernames and passwords on the fly.</p></li>
</ol>

<p><img src="/assets/NgrBot/iexplorer_attach/modules/grabber.png" alt="grabber" /></p>

<ol>
<li><p><strong>FTP Login Grabber</strong></p>

<p>This module hooks <strong>ws2_32!send</strong> to grab the FTP logins as they are used.</p></li>
</ol>

<p><img src="/assets/NgrBot/iexplorer_attach/modules/grabber_ftp.png" alt="grabber_ftp" /></p>

<ol>
<li><p><strong>MSN Spreader</strong></p>

<p>The module also hooks <strong>ws2_32!send</strong> to detect MSN messages being send. It will then monitor outgoing messages and wait until a determinate number messages are sent to replace one with a custom spread message (a link to download the Malware).</p></li>
</ol>

<p><img src="/assets/NgrBot/iexplorer_attach/modules/msm.png" alt="msm" /></p>

<ol>
<li><p><strong>USB Spreader</strong></p>

<p>It waits for USB devices to be plugged and then attempts to infect it using multiple .lnk methods and an obfuscated &ldquo;autorun&rdquo; file. Following we can see an example of an &ldquo;autorun&rdquo; file:</p></li>
</ol>
<div class="highlight"><pre><code class="language-actionScript" data-lang="actionScript"><span></span>	<span class="p">[</span><span class="nx">autorun</span><span class="p">]</span>
	<span class="nx">shell</span><span class="o">\</span><span class="nx">open</span><span class="o">\</span><span class="nx">command</span><span class="o">=</span>
	<span class="nx">shell</span><span class="o">\</span><span class="nx">explore</span><span class="o">\</span><span class="nx">command</span><span class="o">=</span>
	<span class="nx">con</span><span class="o">=</span><span class="nx">shell32</span><span class="p">.</span><span class="nx">dll</span><span class="o">,</span><span class="mi">7</span>
	<span class="nx">useautoplay</span><span class="o">=</span><span class="mi">1</span>
	<span class="nx">action</span><span class="o">=</span><span class="nx">Open</span> <span class="nx">folder</span> <span class="nx">to</span> <span class="nx">view</span> <span class="nx">files</span>
	<span class="nx">shellexecute</span><span class="o">=</span>
	<span class="o">%</span><span class="nx">windir</span><span class="o">%\</span><span class="nx">system32</span><span class="o">\</span><span class="nx">cmd</span><span class="p">.</span><span class="nx">exe</span>
	<span class="o">&amp;&amp;%%</span><span class="nx">windir</span><span class="o">%%\</span><span class="nx">explorer</span><span class="p">.</span><span class="nx">exe</span> <span class="o">%%</span><span class="nx">cd</span><span class="o">%%%</span><span class="nx">s</span>
	<span class="o">/</span><span class="nx">c</span> <span class="err">&quot;</span><span class="nx">start</span> <span class="o">%%</span><span class="nx">cd</span><span class="o">%%</span><span class="nx">RECYCLER</span><span class="o">\%</span><span class="nx">s</span>
</code></pre></div>

<h2 id="conclusion">Conclusion</h2>

<p>Finally we have already  finished of fantastic analysis of the &ldquo;NrgBot&rdquo;. The fist time I saw it I have to confess that I thought that it was just another regular bot but as we have seen it much more than that. So the moral is to never underestimate a new sample and let your curiosity flow freely :).</p>

<p>With this series of post I pretended to show how I usually proceed when I faced a new Malware analysis and I hope that it has been illustrative for all the reader.</p>

<h2 id="tools">Tools</h2>

<pre><code>* IDA pro
* Wireshark
</code></pre>

                    </div>
                    <div class="hmdl-page-comments mdl-color-text--primary-contrast mdl-card__supporting-text comments"> 
                        <strong>
                            	<strong>Doopel</strong>
						</strong>
                        <p></p>
                    </div>  
                </div>                
                <nav class="mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
                    <a href="/post/ngrbot/dropper_analisys/">
                        <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                        <i class="icon ion-android-arrow-back"></i>
                        </button>
                        Older
                    </a>
                    <div class="section-spacer"></div>
                </nav>
 
            </div>        
        </main>
        <footer class="mdl-mini-footer">
            <div class="mdl-mini-footer--left-section">                
                <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-mini-footer--social-btn social-btn" href="mailto:pwn4tion@gmail.com?subject=Hi">
                    <i class="material-icons_lg icon ion-email"></i>
                    <span class="visuallyhidden">Email</span>
                </a>
                <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-mini-footer--social-btn social-btn" href="https://github.com/Pwnation">
                    <i class="material-icons_lg icon ion-social-github"></i>
                    <span class="visuallyhidden">Github</span>
                </a>
                <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-mini-footer--social-btn social-btn" href="https://twitter.com/PwnationBlog">
                    <i class="material-icons_lg icon ion-social-twitter "></i>
                    <span class="visuallyhidden">Twitter</span>
                </a>


            </div>
            <div class="mdl-mini-footer--right-section">
                <span>© 2017 </span>
            </div>
        </footer>
        <div class="mdl-layout__obfuscator"></div>
    </div>
    <script src="https://code.getmdl.io/1.1.3/material.min.js"></script>


</body>
</html>

